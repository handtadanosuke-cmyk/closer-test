<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Closer</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ•° --- */
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --accent: #FFD700; 
            --toggle-on: #ffcc00; 
            --premium: #ff2d55; 
            --standard: #007aff; 
            --company: #34c759; 
            --danger: #ff453a;
            --coin: #FFA500;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --menu-width: 280px;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh; height: 100dvh;
            overflow: hidden;
            user-select: none;
        }

        /* --- ç”»é¢ç®¡ç† --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; overflow-y: auto;
            background: var(--bg-color);
            padding-top: var(--safe-top); padding-bottom: var(--safe-bottom);
            animation: fadeIn 0.2s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- UIãƒ‘ãƒ¼ãƒ„ --- */
        .btn {
            display: flex; justify-content: center; align-items: center;
            width: 100%; padding: 16px; border-radius: 12px;
            font-weight: 700; font-size: 16px; cursor: pointer; border: none;
            transition: opacity 0.1s; margin-bottom: 12px;
        }
        .btn:active { opacity: 0.7; }
        .btn-gold { background: var(--accent); color: #000; }
        .btn-standard { background: var(--standard); color: #fff; }
        .btn-premium { background: var(--premium); color: #fff; }
        .btn-company { background: var(--company); color: #fff; }
        .btn-coin { background: var(--coin); color: #000; }
        .btn-outline { background: transparent; border: 1px solid var(--text-sub); color: var(--text-main); }
        .btn-text { background: transparent; color: var(--text-sub); font-size: 14px; text-decoration: underline; }
        .btn-danger { background: rgba(255, 69, 58, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-apple { background: #fff; color: #000; margin-bottom: 15px; position:relative; }
        .btn-apple::before { content: 'ï£¿ Pay'; font-family: -apple-system; font-weight: 600; font-size: 18px; }
        .btn-sm { padding: 8px 16px; font-size: 12px; border-radius: 20px; width: auto; display: inline-block; margin: 0; }

        /* å°ã•ã„ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-icon-sm { padding: 5px 10px; border-radius: 6px; font-size: 12px; background: #333; color: #ccc; cursor: pointer; margin-left: 5px; border: none; }
        .btn-icon-sm.delete { color: var(--danger); background: rgba(255, 69, 58, 0.1); }
        .btn-icon-sm.save { color: var(--accent); border: 1px solid var(--accent); background: transparent; }
        .btn-icon-sm.save.saved { background: var(--accent); color: #000; }
        .btn-icon-sm.disabled, .action-item.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); }

        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 15px;
            background: var(--card-bg); border: 1px solid #333;
            border-radius: 10px; color: var(--text-main); font-size: 16px;
            outline: none;
            color: var(--text-main); 
        }
        input:disabled { background: #111; color: #555; border-color: #222; }
        textarea { resize: none; }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå…±é€šï¼‰ --- */
        .app-header {
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            padding: 10px 15px; position: sticky; top: 0; z-index: 10;
            border-bottom: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px;
        }
        .menu-btn { font-size: 24px; cursor: pointer; padding: 5px; width: 40px; }
        .header-action { width: 40px; text-align: right; font-size: 20px; cursor: pointer; position: relative; }
        .notification-badge { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: none; }
        .notification-badge.active { display: block; }

        .logo-btn { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .logo-icon { font-size: 20px; }
        .logo-text { font-weight: 800; font-size: 20px; color: var(--text-main); letter-spacing: 0.5px; font-family: 'Georgia', serif; }

        /* --- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ --- */
        #menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 998;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #menu-overlay.open { opacity: 1; pointer-events: auto; }

        #side-menu {
            position: fixed; top: 0; left: 0; width: var(--menu-width); height: 100%;
            background: #151515; z-index: 999;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            padding-top: calc(var(--safe-top) + 20px);
            border-right: 1px solid #333;
            display: flex; flex-direction: column;
        }
        #side-menu.open { transform: translateX(0); }

        .menu-header { padding: 20px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .menu-user-icon { width: 50px; height: 50px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; font-size: 24px; border: 2px solid var(--accent); overflow: hidden; }
        .menu-user-icon img { width: 100%; height: 100%; object-fit: cover; }
        .menu-user-name { font-weight: bold; font-size: 16px; margin-bottom: 3px; }
        .menu-user-rank { font-size: 11px; color: var(--accent); border: 1px solid var(--accent); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .menu-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; color: var(--text-main); font-size: 15px; cursor: pointer; transition: background 0.2s; }
        .menu-item:active { background: #222; }
        .menu-icon { margin-right: 12px; font-size: 18px; width: 24px; text-align: center; }

        /* --- èªè¨¼ãƒ»ç™»éŒ²é–¢é€£ --- */
        .auth-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; color: #666; cursor: pointer; border-bottom: 2px solid transparent; }
        .auth-tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .choice-tag { padding: 8px 12px; border-radius: 20px; border: 1px solid #444; color: var(--text-sub); font-size: 12px; cursor: pointer; }
        .choice-tag.selected { background: var(--accent); color: #000; border-color: var(--accent); }
        .avatar-uploader { width: 100px; height: 100px; background: #222; border-radius: 50%; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden; border: 1px dashed #555; }
        .avatar-uploader img { width: 100%; height: 100%; object-fit: cover; }

        /* --- ã‚«ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ --- */
        .content { padding: 20px; flex: 1; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 15px; position: relative; overflow: hidden; cursor: pointer; }
        .card:active { opacity: 0.9; }
        .card-meta { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; color: #888; }
        .card-user { display: flex; align-items: center; gap: 5px; }
        .user-mini-icon { width: 20px; height: 20px; border-radius: 50%; background: #444; object-fit: cover; }
        .rank-badge { background: var(--accent); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .q-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; line-height: 1.5; color: var(--text-main); }
        .q-context { font-size: 13px; color: #aaa; margin-bottom: 10px; padding: 8px; background: #222; border-radius: 8px; border-left: 2px solid #555; }
        .tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
        .tag { background: #000; border: 1px solid #333; color: #aaa; padding: 4px 10px; border-radius: 20px; font-size: 10px; }
        .card-actions { display: flex; border-top: 1px solid #333; padding-top: 10px; }
        .action-item { flex: 1; text-align: center; font-size: 13px; color: #888; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; z-index: 2; position: relative; }
        .action-item.active { color: var(--accent); }

        /* --- è©³ç´°ãƒ»å›ç­” --- */
        .answer-card { background: #151515; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 3px solid #333; cursor: pointer; }
        .answer-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        .answer-author { display: flex; align-items: center; gap: 8px; color: #fff; font-weight: bold; }
        .answer-body { font-size: 15px; line-height: 1.6; margin-bottom: 15px; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .answer-reason { font-size: 13px; color: #aaa; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #333; }
        .reply-box { margin-top: 10px; padding: 10px; background: #222; border-radius: 8px; font-size: 13px; color: #ccc; }
        .reply-header { font-size: 11px; color: #888; margin-bottom: 4px; }
        /* ã¼ã‹ã—ãƒ»ãƒ­ãƒƒã‚¯ */
        .blur-content { filter: blur(8px); user-select: none; opacity: 0.5; pointer-events: none; }
        .locked-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); z-index: 10; border-radius: 12px; }

        /* è©•ä¾¡UI */
        .rating-grid { display: flex; flex-direction:column; gap:8px; margin-top:10px; padding:10px; background:#222; border-radius:8px; }
        .rating-row { display: flex; align-items: center; justify-content: space-between; font-size: 12px; }
        .rating-slider { flex: 1; margin: 0 10px; accent-color: var(--accent); }
        .rating-val { width: 30px; text-align: right; color: var(--accent); font-weight: bold; }
        .save-btn { background: #1a1a1a; color: var(--accent); border: 1px solid var(--accent); width:100%; margin-top:5px; }
        .save-btn.selected { background: var(--accent); color: #000; }

        /* --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« --- */
        .profile-header { text-align: center; padding: 20px; background: linear-gradient(180deg, #111 0%, #000 100%); }
        .profile-icon { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); margin: 0 auto 15px; object-fit: cover; }
        .profile-name { font-size: 22px; font-weight: bold; margin-bottom: 5px; display:flex; justify-content:center; align-items:center; gap:5px; }
        .pro-badge { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; vertical-align: middle; }
        .profile-meta { font-size: 12px; color: #888; margin-bottom: 15px; }
        .profile-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .stat-box { text-align: center; min-width: 80px; }
        .stat-val { font-size: 18px; font-weight: 800; color: var(--accent); }
        .stat-label { font-size: 10px; color: #666; }
        .profile-bio { font-size: 13px; color: #ccc; line-height: 1.5; padding: 0 20px; margin-bottom: 20px; }
        .coin-balance { font-size:14px; color:var(--coin); margin-bottom:10px; font-weight:bold; cursor:pointer; }
        .subscribed-badge { background: #333; color: #aaa; font-size: 12px; padding: 8px 20px; border-radius: 20px; border: 1px solid #555; margin-top: 10px; display: inline-block; }
        .social-links { display:flex; gap:10px; justify-content:center; margin-bottom:15px; }
        .social-icon { font-size:18px; color:#aaa; cursor:pointer; text-decoration:none; }
        
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ– */
        .profile-tabs { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .profile-tab { flex: 1; text-align: center; padding: 12px; color: #666; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold; }
        .profile-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†…ãƒãƒ£ãƒƒãƒˆ */
        .dm-container { height: 300px; display: flex; flex-direction: column; background: #111; border-radius: 12px; margin: 0 20px; position: relative; overflow: hidden; }
        .dm-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 5; flex-direction: column; }

        /* --- è¨­å®š --- */
        .settings-container { padding: 20px; }
        .settings-section { margin-bottom: 30px; }
        .settings-title { font-size: 13px; color: var(--text-sub); margin-bottom: 8px; padding-left: 10px; text-transform: uppercase; font-weight: 600; }
        .settings-group { background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        .settings-item { padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2c2c2e; cursor: pointer; }
        .settings-item:last-child { border-bottom: none; }
        .settings-value { font-size:14px; color:#888; }
        .toggle-switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #39393d; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .toggle-slider { background-color: var(--toggle-on); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* FAB */
        .fab { position: fixed; bottom: 30px; right: 20px; width: 60px; height: 60px; background: var(--accent); color: #000; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2); z-index: 50; cursor: pointer; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-card { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 100%; max-width: 320px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 10px; font-size: 24px; color: #888; cursor: pointer; }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ */
        .sort-bar { display: flex; gap: 10px; padding: 0 15px 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .filter-tag { display: inline-block; padding: 6px 12px; border-radius: 20px; background: #333; color: #aaa; font-size: 12px; margin: 4px; cursor: pointer; border: 1px solid transparent; white-space: nowrap; }
        .filter-tag.selected { background: var(--accent); color: #000; border-color: var(--accent); }
        .sort-chip { padding: 6px 12px; border-radius: 8px; background: #222; color: #888; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .sort-chip.active { background: #444; color: #fff; font-weight: bold; }
        
        /* æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ  */
        .secure-field { display: flex; align-items: center; background: #000; border: 1px solid #444; border-radius: 8px; padding: 0 10px; margin-bottom: 15px; }
        .secure-icon { color: #888; font-size: 18px; margin-right: 10px; }
        .secure-input { background: transparent; border: none; color: #fff; margin: 0; padding: 12px 0; font-family: monospace; }
        .secure-note { font-size: 10px; color: #666; text-align: center; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* AI Chat */
        .chat-container { display: flex; flex-direction: column; height: 400px; background: #111; border-radius: 12px; overflow: hidden; margin-top:20px; }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
        .bubble-ai { background: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .bubble-user { background: var(--accent); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; font-weight: bold; }
        .chat-input-area { padding: 10px; background: #222; display: flex; gap: 10px; }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ */
        .user-card { display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .user-card-left { display: flex; align-items: center; gap: 12px; }
        .user-rank-num { font-size: 16px; font-weight: bold; color: #666; width: 25px; }
        .user-rank-num.top3 { color: var(--accent); font-size: 20px; }
        .user-score { font-size: 18px; font-weight: 800; color: var(--accent); }

        /* é€šçŸ¥ä¸€è¦§ */
        .notification-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #333; font-size: 13px; text-align: left; cursor: pointer; }
        .notification-item:last-child { border-bottom: none; }
        .notif-icon { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 10px; font-size: 16px; }
        .notif-content { flex: 1; }
        .notif-time { font-size: 11px; color: #666; margin-top: 4px; }

        /* å›ç­”å…¨æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #answer-detail-text { white-space: pre-wrap; text-align: left; line-height: 1.6; margin-bottom: 20px; font-size: 15px; max-height: 60vh; overflow-y: auto; }

        /* FAQ */
        .faq-item { background: #222; border-radius: 8px; margin-bottom: 10px; padding: 15px; cursor: pointer; }
        .faq-q { font-weight: bold; margin-bottom: 5px; color: var(--text-main); }
        .faq-a { font-size: 13px; color: #aaa; display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444; }
        .faq-item.open .faq-a { display: block; }
/* è©³ç´°ç”»é¢ç”¨ã®ãƒœãƒƒã‚¯ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        .detail-box {
            background: #222;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            color: #fff;
            white-space: pre-wrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu">
        <div class="menu-search">
            <input type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." onkeypress="if(event.key==='Enter') { performSearch(this.value); toggleMenu(); }">
        </div>
        <div class="menu-header" onclick="menuAction('profile-screen', true)">
            <div class="menu-user-icon">
                <img id="menu-icon-img" src="" style="display:none;">
                <span id="menu-icon-placeholder">ğŸ‘¤</span>
            </div>
            <div>
                <div class="menu-user-name" id="menu-username">Guest</div>
                <div class="menu-user-rank" id="menu-userrank">Rate: --</div>
            </div>
        </div>
        <div class="menu-list">
            <div class="menu-item" onclick="menuAction('timeline-screen')">
                <span class="menu-icon">ğŸ•˜</span> ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
            </div>
            <div class="menu-item" onclick="menuAction('ranking-screen')">
                <span class="menu-icon">ğŸ”¥</span> æŠ•ç¨¿ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            </div>
            <div class="menu-item" onclick="showCuriousList()">
                <span class="menu-icon">ğŸ¤”</span> æ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆ
            </div>
            <div class="menu-item" onclick="menuAction('user-ranking-screen')">
                <span class="menu-icon">ğŸ‘‘</span> ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            </div>
            <div class="menu-item" onclick="menuAction('scout-screen')">
                <span class="menu-icon">ğŸ¢</span> ä¼æ¥­ã‚¹ã‚«ã‚¦ãƒˆ
            </div>
            <div class="menu-item" onclick="checkMemberAccess('bookmarks-screen')">
                <span class="menu-icon">ğŸ“‚</span> ãƒã‚¤å˜èªå¸³
            </div>
            <div class="menu-item" onclick="checkMemberAccess('ai-practice-screen')">
                <span class="menu-icon">ğŸ¤–</span> AIå£æ‰“ã¡ç·´ç¿’ <span style="font-size:10px; color:var(--accent); border:1px solid var(--accent); padding:1px 3px; border-radius:3px; margin-left:5px;">NEW</span>
            </div>
            <div class="menu-item" onclick="checkMemberAccess(null, 'company')">
                <span class="menu-icon">ğŸ¢</span> ç¤¾å†…é™å®šãƒ—ãƒ©ãƒ³
            </div>
            <hr style="border:0; border-top:1px solid #333; margin:10px 20px;">
            <div class="menu-item" onclick="menuAction('settings-screen')">
                <span class="menu-icon">âš™ï¸</span> è¨­å®š / ãŠå•ã„åˆã‚ã›
            </div>
        </div>
        <div style="padding: 20px; font-size: 11px; color: #555; text-align: center;">Closer v7.7.1</div>
    </div>

    <div id="welcome-screen" class="screen active" style="justify-content:center; align-items:center; text-align:center; padding:40px; background: radial-gradient(circle at center, #222 0%, #000 100%);">
        <div style="margin-bottom: 60px;">
            <div style="font-size:48px; font-weight:900; margin-bottom:10px;">ğŸ”‘ Closer</div>
            <div style="font-size:14px; color:#888;">å–¶æ¥­ã®ã€Œç¾å ´çŸ¥ã€å…±æœ‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </div>
        </div>
        <div style="width: 100%; max-width: 320px;">
            <button class="btn btn-outline" onclick="startAsGuest()">ç™»éŒ²ãªã—ã§è©¦ã™</button>
            <button class="btn btn-gold" onclick="navTo('auth-screen')">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</button>
        </div>
    </div>

    <div id="auth-screen" class="screen">
        <div class="app-header" style="justify-content: flex-start;">
             <div class="menu-btn" onclick="navTo('welcome-screen')" style="font-size:20px;">â† TOP</div>
        </div>
        <div style="padding:20px; text-align:center;"><h2>Members Only</h2></div>
        <div class="auth-tabs">
            <div class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">æ–°è¦ç™»éŒ²</div>
            <div class="auth-tab" id="tab-login" onclick="switchAuthTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</div>
        </div>
        <div id="auth-flow-register" style="padding:20px;">
            <div id="reg-step-1">
                <label style="font-size:12px; color:#888;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color:var(--danger)">*</span></label>
                <input type="email" id="reg-email" placeholder="example@email.com">
                <button class="btn btn-gold" onclick="checkDeviceAndSendCode()">èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
            </div>
            <div id="reg-step-2" style="display:none;">
                <label style="font-size:12px; color:#888;">èªè¨¼ã‚³ãƒ¼ãƒ‰</label>
                <input type="tel" id="reg-code" placeholder="4æ¡ã®ã‚³ãƒ¼ãƒ‰">
                <button class="btn btn-gold" onclick="verifyCode()">èªè¨¼</button>
            </div>
            <div id="reg-step-3" style="display:none;">
                <p style="font-size:12px; color:#888; margin-bottom:5px;">åŸºæœ¬æƒ…å ± <span style="color:var(--danger)">*å¿…é ˆ</span></p>
                <input type="text" id="reg-name" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ " required>
                <input type="password" id="reg-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(5-15æ–‡å­—)" required>
                <input type="date" id="reg-birth" style="color-scheme: dark;">
                <label style="font-size:12px; color:#888;">å–ã‚Šæ‰±ã„å•†æï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                <div class="tag-container" id="product-tags"></div>
                <button class="btn btn-gold" onclick="goToBioStep()">æ¬¡ã¸</button>
            </div>
            <div id="reg-step-4" style="display:none;">
                <p style="font-size:12px; color:#888; margin-bottom:5px;">è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</p>
                <div class="avatar-uploader" onclick="document.getElementById('file-input').click()">
                    <div id="avatar-preview" class="placeholder">ğŸ“·</div>
                    <img id="avatar-img" src="" style="display:none;">
                </div>
                <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="previewImage(this)">
                <input type="text" id="reg-history" placeholder="ç¤¾æ­´ï¼ˆä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡ 3å¹´ï¼‰">
                <input type="text" id="reg-role" placeholder="å½¹è·ï¼ˆä¾‹ï¼šå–¶æ¥­éƒ¨é•·ï¼‰">
                <textarea id="reg-bio" rows="3" placeholder="è‡ªå·±ç´¹ä»‹"></textarea>
                <button class="btn btn-gold" onclick="completeRegistration()">ç™»éŒ²å®Œäº†</button>
            </div>
        </div>
        <div id="auth-flow-login" style="padding:20px; display:none;">
            <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button class="btn btn-gold" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
    </div>

    <div id="timeline-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action" onclick="toggleNotification()">ğŸ””<div id="badge-timeline" class="notification-badge"></div></div>
        </div>
        <div id="timeline-label" style="padding:10px 15px; color:#888; font-size:12px; display:flex; justify-content:space-between;">
            <span id="timeline-title">æ–°ç€ã®æ‚©ã¿</span>
            <div style="display:flex; gap:10px;">
                 <span onclick="openFilterModal()" style="cursor:pointer;">ğŸŒªï¸ çµã‚Šè¾¼ã¿</span>
                 <span onclick="randomizeTimeline()" style="cursor:pointer;">ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ </span>
            </div>
        </div>
        <div class="sort-bar">
            <div class="sort-chip active" id="sort-new" onclick="setSort('new')">æ–°ç€é †</div>
            <div class="sort-chip" id="sort-popular" onclick="setSort('popular')">å›ç­”æ•°é †</div>
            <div class="sort-chip" id="sort-unanswered" onclick="setSort('unanswered')">æœªå›ç­”ã®ã¿</div>
        </div>
        <div class="content" id="timeline-list"></div>
        <div class="fab" onclick="checkMemberAccess(null, 'post')">ï¼‹</div>
    </div>

    <div id="ranking-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action" onclick="toggleNotification()">ğŸ””<div id="badge-ranking" class="notification-badge"></div></div>
        </div>
        <div style="padding:10px 15px; background:linear-gradient(90deg, #333 0%, #000 100%); color:#fff; font-size:14px; font-weight:bold; display:flex; align-items:center; gap:5px;">
            <span>ğŸ”¥</span> éœ€è¦ã®é«˜ã„ãŠé¡Œãƒ©ãƒ³ã‚­ãƒ³ã‚°
        </div>
        <div class="content" id="ranking-list"></div>
    </div>

    <div id="user-ranking-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action"></div>
        </div>
        <div style="padding:10px 15px; background:linear-gradient(90deg, #333 0%, #000 100%); color:var(--accent); font-size:14px; font-weight:bold; display:flex; align-items:center; gap:5px;">
            <span>ğŸ‘‘</span> æœ¬è³ªçš„å–¶æ¥­åŠ›ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        </div>
        <div class="content" id="user-ranking-list"></div>
    </div>

    <div id="scout-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="toggleMenu()">â˜°</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action"></div>
        </div>
        <div style="padding:10px 15px; background:linear-gradient(90deg, #333 0%, #000 100%); color:var(--company); font-size:14px; font-weight:bold; display:flex; align-items:center; gap:5px;">
            <span>ğŸ¢</span> ä¼æ¥­ã‚¹ã‚«ã‚¦ãƒˆ
        </div>
        <div class="content">
            <div class="card">
                <div class="card-meta"><span>æœ¬æ—¥ 10:00</span><span>æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£</span></div>
                <div class="q-title">ã€é¢è«‡ç¢ºç´„ã€‘ã‚ãªãŸã®å›ç­”ã€Œäºˆç®—ãŒãªã„æ™‚ã®åˆ‡ã‚Šè¿”ã—ã€ã‚’æ‹è¦‹ã—ã€ã”é€£çµ¡ã—ã¾ã—ãŸã€‚</div>
                <div class="q-context" style="margin-top:10px;">å¹´å800ä¸‡å††ã€œ / ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆå¯ / ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã‚ã‚Š</div>
                <div class="card-actions">
                    <div class="action-item" onclick="alert('è©³ç´°ã‚’ç¢ºèªã—ã¾ã™')">è©³ç´°ã‚’è¦‹ã‚‹</div>
                    <div class="action-item" style="color:var(--accent);" onclick="startChatWithCompany('æ ªå¼ä¼šç¤¾ã€‡ã€‡ä¸å‹•ç”£')">è¿”ä¿¡ã™ã‚‹</div>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="backToPrev()">â†</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action"></div>
        </div>
        <div class="content">
            <h2 id="detail-title" style="font-size:18px; margin-bottom:10px; padding:0 5px;">ã‚¿ã‚¤ãƒˆãƒ«</h2>
            <div id="detail-context" class="q-context" style="display:none;"></div>
            <div id="detail-tags" class="tags" style="padding:0 5px;"></div>
            <div style="margin-top:20px; margin-bottom:10px; font-size:12px; color:#888; padding:0 5px;">å›ç­”ä¸€è¦§</div>
            <div id="answer-list"></div>
        </div>
    </div>

    <div id="profile-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="backToPrev()">â†</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action"></div>
        </div>
        <div class="profile-header">
            <img id="prof-img" class="profile-icon" src="">
            <div id="prof-name" class="profile-name">Name</div>
            <div id="prof-role" class="profile-meta">Role / Company</div>
            <div class="social-links" id="prof-social"></div>
            <div class="profile-stats">
                <div class="stat-box"><div class="stat-val" id="prof-rate">--</div><div class="stat-label">Rate</div></div>
                <div class="stat-box"><div class="stat-val" id="prof-answers-count">--</div><div class="stat-label">Answers</div></div>
            </div>
            <div id="prof-coin-display" class="coin-balance" onclick="openWalletModal()" style="display:none;">ğŸª™ -- Coins</div>
            <div id="prof-bio" class="profile-bio">Bio...</div>
            <div style="padding:0 20px;" id="prof-action-area"></div>
        </div>
        <div class="profile-tabs">
            <div class="profile-tab active" id="tab-prof-posts" onclick="switchProfileTab('posts')">å…¬é–‹æŠ•ç¨¿</div>
            <div class="profile-tab" id="tab-prof-chat" onclick="switchProfileTab('chat')">1on1 ãƒãƒ£ãƒƒãƒˆ</div>
        </div>
        <div class="content" id="prof-content-area">
            <!-- æŠ•ç¨¿ä¸€è¦§ or ãƒãƒ£ãƒƒãƒˆ -->
        </div>
    </div>

    <div id="ai-practice-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="backToPrev()">â†</div>
            <div class="logo-btn"><span class="logo-icon">ğŸ¤–</span><span class="logo-text" style="color:var(--accent);">AI Training</span></div>
            <div class="header-action"></div>
        </div>
        <div class="content">
            <div style="font-size:16px; font-weight:bold; margin-bottom:10px;">AIå£æ‰“ã¡</div>
            <div style="margin-bottom:10px;">
                <select id="ai-scenario-select" style="font-size:12px; padding:8px;">
                    <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç†ä¸å°½ãªå®¢ï¼‰</option>
                </select>
                <div style="font-size:10px; color:#888;">ä¿å­˜ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é¸æŠã—ã¦ç·´ç¿’ã§ãã¾ã™</div>
            </div>
            <div class="chat-container">
                <div id="ai-chat-area" class="chat-area">
                    <div class="chat-bubble bubble-ai">ç¤¾é•·ã ã€‚ç”¨ä»¶ã¯æ‰‹çŸ­ã«ãªã€‚ä»Šå¿™ã—ã„ã‚“ã ã€‚</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="ai-chat-input" placeholder="ãƒˆãƒ¼ã‚¯ã‚’å…¥åŠ›..." style="margin:0; font-size:14px;">
                    <button class="btn btn-gold" style="width:60px; margin:0;" onclick="sendAIMessage()">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-screen" class="screen">
        <div class="sub-header" style="display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #222;">
            <div onclick="backToPrev()" style="font-size:24px; margin-right:15px; cursor:pointer;">â†</div>
            <div style="font-weight:800; font-size:18px;">Settings</div>
        </div>
        <div class="settings-container">
            <div class="settings-section">
                <div class="settings-title">ğŸ”” Notification Settings</div>
                <div class="settings-group">
                    <div class="settings-item"><div class="settings-label">ä¼æ¥­ã‹ã‚‰ã®ã‚¹ã‚«ã‚¦ãƒˆ</div><label class="toggle-switch"><input type="checkbox" id="conf-scout" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                    <div class="settings-item"><div class="settings-label">æŠ•ç¨¿ã¸ã®ã€Œæ°—ã«ãªã‚‹ã€</div><label class="toggle-switch"><input type="checkbox" id="conf-curious" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                    <div class="settings-item"><div class="settings-label">å›ç­”ã¸ã®è©•ä¾¡</div><label class="toggle-switch"><input type="checkbox" id="conf-rate" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                    <div class="settings-item"><div class="settings-label">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å…¥è³</div><label class="toggle-switch"><input type="checkbox" id="conf-rank" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                    <div class="settings-item"><div class="settings-label">ã‚µãƒ–ã‚¹ã‚¯åŠ å…¥è€…</div><label class="toggle-switch"><input type="checkbox" id="conf-sub" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                    <div class="settings-item"><div class="settings-label">é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div><label class="toggle-switch"><input type="checkbox" id="conf-admin" onchange="saveConfig()"><span class="toggle-slider"></span></label></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">ğŸ’° Payment & Plan</div>
                <div class="settings-group">
                    <div class="settings-item" onclick="openWalletModal()"><div class="settings-label" style="color:var(--coin);">ğŸª™ ã‚³ã‚¤ãƒ³ç®¡ç† (è³¼å…¥)</div><div class="settings-value">â€º</div></div>
                    <div class="settings-item" onclick="openSystemPlanModal()"><div class="settings-label">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ©ãƒ³å¤‰æ›´</div><div class="settings-value" id="setting-plan-val">Free</div></div>
                    <div class="settings-item" onclick="openCreatorModal()"><div class="settings-label">è‡ªåˆ†ã®ã‚µãƒ–ã‚¹ã‚¯è¨­å®š</div><div class="settings-value">â€º</div></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">ğŸ‘¤ Account</div>
                <div class="settings-group">
                    <div class="settings-item" onclick="openProfileEdit()"><div class="settings-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</div><div class="settings-value">â€º</div></div>
                    <div class="settings-item" onclick="logout()"><div class="settings-label" style="color:var(--accent);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div></div>
                    <div class="settings-item" onclick="requestAccountDeletion()"><div class="settings-label" style="color:var(--danger);">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤</div></div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-title">â„¹ï¸ Info</div>
                <div class="settings-group">
                    <div class="settings-item" onclick="navTo('contact-screen')"><div class="settings-label">ãŠå•ã„åˆã‚ã›</div><div class="settings-value">â€º</div></div>
                    <div class="settings-item" onclick="navTo('faq-screen')"><div class="settings-label">ã‚ˆãã‚ã‚‹è³ªå•</div><div class="settings-value">â€º</div></div>
                    <div class="settings-item" onclick="navTo('terms-screen')"><div class="settings-label">åˆ©ç”¨è¦ç´„</div><div class="settings-value">â€º</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãŠå•ã„åˆã‚ã›ç”»é¢ -->
    <div id="contact-screen" class="screen">
        <div class="sub-header" style="display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #222;">
            <div onclick="backToPrev()" style="font-size:24px; margin-right:15px; cursor:pointer;">â†</div><div style="font-weight:800;">Contact</div>
        </div>
        <div style="padding:20px;">
            <p style="font-size:12px; color:#888;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn btn-sm btn-outline" onclick="selectContactType(this)">æ©Ÿèƒ½è¦æœ›</button>
                <button class="btn btn-sm btn-outline" onclick="selectContactType(this)">ä¸å…·åˆå ±å‘Š</button>
                <button class="btn btn-sm btn-outline" onclick="selectContactType(this)">ãã®ä»–</button>
            </div>
            <textarea id="contact-msg" rows="6" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." style="background:#222;"></textarea>
            <div style="margin-bottom:20px;">
                <label style="font-size:12px; color:#888;"><input type="checkbox"> å†…å®¹ã‚’å…¬é–‹ã—ã¦ã‚‚ã‚ˆã„ï¼ˆFAQã«æ²è¼‰ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰</label>
            </div>
            <button class="btn btn-gold" onclick="alert('é€ä¿¡ã—ã¾ã—ãŸã€‚\né‹å–¶ãƒ¡ãƒ¼ãƒ«ã¸è»¢é€ã•ã‚Œã¾ã™ã€‚')">é€ä¿¡</button>
            
            <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <div style="font-size:12px; color:#888; margin-bottom:10px;">é‹å–¶ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹</div>
                <div style="background:#222; padding:15px; border-radius:8px; font-size:13px; color:#aaa;">ç¾åœ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
            </div>
        </div>
    </div>

    <!-- FAQç”»é¢ -->
    <div id="faq-screen" class="screen">
        <div class="sub-header" style="display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #222;">
            <div onclick="backToPrev()" style="font-size:24px; margin-right:15px; cursor:pointer;">â†</div><div style="font-weight:800;">FAQ</div>
        </div>
        <div style="padding:20px;">
            <input type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." style="margin-bottom:20px;">
            <div class="faq-item" onclick="this.classList.toggle('open')">
                <div class="faq-q">Q. ç„¡æ–™ã§ä½¿ãˆã¾ã™ã‹ï¼Ÿ</div>
                <div class="faq-a">A. åŸºæœ¬æ©Ÿèƒ½ã¯ç„¡æ–™ã§ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚ä¸€éƒ¨æ©Ÿèƒ½ã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ã¸ã®åŠ å…¥ãŒå¿…è¦ã§ã™ã€‚</div>
            </div>
            <div class="faq-item" onclick="this.classList.toggle('open')">
                <div class="faq-q">Q. é€€ä¼šæ–¹æ³•ã¯ï¼Ÿ</div>
                <div class="faq-a">A. è¨­å®šç”»é¢ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‹ã‚‰æ‰‹ç¶šãå¯èƒ½ã§ã™ã€‚</div>
            </div>
            <div class="faq-item" onclick="this.classList.toggle('open')">
                <div class="faq-q">Q. ã‚¹ã‚³ã‚¢ã®ç®—å‡ºæ–¹æ³•ã¯ï¼Ÿ</div>
                <div class="faq-a">A. ç‹¬è‡ªã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«åŸºã¥ãã€è©•ä¾¡æ•°ã€ä¿å­˜æ•°ã€æŠ•ç¨¿é »åº¦ãªã©ã‹ã‚‰ç®—å‡ºã—ã¦ã„ã¾ã™ã€‚</div>
            </div>
        </div>
    </div>
<div id="answer-view-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="backToPrev()">â†</div>
            <div class="logo-btn" onclick="refreshApp()">
                <span class="logo-icon">ğŸ”‘</span>
                <span class="logo-text" style="color:var(--accent);">Closer</span>
            </div>
            <div class="header-action"></div>
        </div>
        <div class="content">
            <div style="font-size:12px; color:#888; margin-bottom:5px; margin-left:5px;">å…·ä½“çš„ãªåˆ‡ã‚Šè¿”ã—</div>
            <div class="detail-box" id="view-ans-text">
                </div>

            <div style="font-size:12px; color:#888; margin-bottom:5px; margin-left:5px; margin-top:20px;">ç‹™ã„ãƒ»ç†ç”±</div>
            <div class="detail-box" id="view-ans-reason">
                </div>

            <hr style="border:0; border-top:1px solid #333; margin:30px 0;">

            <div id="rating-input-area">
                <div style="text-align:center; font-weight:bold; margin-bottom:20px;">ã“ã®å›ç­”ã‚’è©•ä¾¡ã—ã¦ã‚¹ã‚³ã‚¢ã‚’è¦‹ã‚‹</div>
                <div class="rating-grid">
                    <div class="rating-row"><span>è«–ç†æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="new-rate-logic" oninput="updateRateVal('logic', this.value)"><span id="val-logic" class="rating-val">3</span></div>
                    <div class="rating-row"><span>å¿œç”¨æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="new-rate-tone" oninput="updateRateVal('tone', this.value)"><span id="val-tone" class="rating-val">3</span></div>
                    <div class="rating-row"><span>å®Ÿç”¨æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="new-rate-empathy" oninput="updateRateVal('empathy', this.value)"><span id="val-empathy" class="rating-val">3</span></div>
                </div>
                <button class="btn btn-gold" onclick="submitNewRating()">è©•ä¾¡ã‚’ç¢ºå®š</button>
                <div style="font-size:10px; color:#666; text-align:center; margin-top:10px;">â€»å…¬å¹³æ€§ã‚’ä¿ã¤ãŸã‚ã€è©•ä¾¡ã™ã‚‹ã¾ã§ã‚¹ã‚³ã‚¢ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</div>
            </div>

            <div id="rating-result-area" style="display:none; text-align:center; padding:20px 0;">
                <div style="font-size:14px; color:#888; margin-bottom:10px;">ã¿ã‚“ãªã®è©•ä¾¡ã‚¹ã‚³ã‚¢</div>
                <div style="font-size:48px; font-weight:900; color:var(--accent);" id="result-score-display">0.00</div>
                <div style="font-size:12px; color:#aaa;" id="result-count-display">Based on 0 votes</div>
                
                <div style="margin-top:20px; padding:15px; background:#222; border-radius:8px; font-size:13px; color:#fff;">
                    ã‚ãªãŸã®è©•ä¾¡ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚<br>ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
                </div>
            </div>
        </div>
    </div>
    <!-- åˆ©ç”¨è¦ç´„ç”»é¢ -->
    <div id="terms-screen" class="screen">
        <div class="sub-header" style="display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #222;">
            <div onclick="backToPrev()" style="font-size:24px; margin-right:15px; cursor:pointer;">â†</div><div style="font-weight:800;">Terms</div>
        </div>
        <div style="padding:20px; font-size:12px; color:#ccc; line-height:1.8;">
            <h3>åˆ©ç”¨è¦ç´„</h3>
            <p><strong>ç¬¬1æ¡ï¼ˆé©ç”¨ï¼‰</strong><br>æœ¬è¦ç´„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å½“ç¤¾ã¨ã®é–“ã®æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«é–¢ã‚ã‚‹ä¸€åˆ‡ã®é–¢ä¿‚ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
            <p><strong>ç¬¬2æ¡ï¼ˆè¿”é‡‘ï¼‰</strong><br>ã‚µãƒ¼ãƒ“ã‚¹ã®æ€§è³ªä¸Šã€è³¼å…¥ã•ã‚ŒãŸã‚³ã‚¤ãƒ³ãŠã‚ˆã³ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ–™é‡‘ã®è¿”é‡‘ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚</p>
            <p><strong>ç¬¬3æ¡ï¼ˆã‚¹ã‚³ã‚¢ç®—å‡ºï¼‰</strong><br>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒ¼ãƒˆï¼ˆã‚¹ã‚³ã‚¢ï¼‰ã¯ã€ä»–è€…ã‹ã‚‰ã®è©•ä¾¡ã€ä¿å­˜æ•°ã€å›ç­”å®Ÿç¸¾ãªã©ã‚’åŸºã«ã€ãƒ™ã‚¤ã‚¸ã‚¢ãƒ³å¹³å‡ç­‰ã®çµ±è¨ˆçš„æ‰‹æ³•ã‚’ç”¨ã„ã¦å½“ç¤¾ç‹¬è‡ªã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚Šç®—å‡ºã•ã‚Œã¾ã™ã€‚ç®—å‡ºãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ã¯éå…¬é–‹ã¨ã—ã€ç•°è­°ç”³ã—ç«‹ã¦ã¯å—ã‘ä»˜ã‘ã¾ã›ã‚“ã€‚</p>
            <p><strong>ç¬¬4æ¡ï¼ˆç¦æ­¢äº‹é …ï¼‰</strong><br>è‡ªä½œè‡ªæ¼”ã«ã‚ˆã‚‹ã‚¹ã‚³ã‚¢æ“ä½œã€ä»–è€…ã¸ã®èª¹è¬—ä¸­å‚·ã€å…¬åºè‰¯ä¿—ã«åã™ã‚‹è¡Œç‚ºã‚’ç¦ã˜ã¾ã™ã€‚</p>
            <p>ï¼ˆä»¥ä¸‹çœç•¥ï¼‰</p>
        </div>
    </div>

    <div id="profile-edit-screen" class="screen">
        <div class="sub-header" style="display:flex; align-items:center; padding:15px 20px; border-bottom:1px solid #222;">
            <div onclick="navTo('settings-screen')" style="font-size:24px; margin-right:15px; cursor:pointer;">â†</div>
            <div style="font-weight:800; font-size:18px;">Edit Profile</div>
        </div>
        <div style="padding:20px;">
            <p style="text-align:center;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ</p>
            <div class="avatar-uploader" onclick="document.getElementById('edit-file-input').click()"><div id="edit-avatar-preview" class="placeholder">ğŸ“·</div><img id="edit-avatar-img" src="" style="display:none;"></div>
            <input type="file" id="edit-file-input" accept="image/*" style="display:none;" onchange="previewEditImage(this)">
            <input type="text" id="edit-name" placeholder="åå‰">
            <input type="email" id="edit-email" disabled style="background:#333; color:#777;">
            <input type="text" id="edit-history" placeholder="ç¤¾æ­´">
            <input type="text" id="edit-role" placeholder="å½¹è·">
            <textarea id="edit-bio" rows="3" placeholder="è‡ªå·±ç´¹ä»‹"></textarea>
            
            <p style="font-size:12px; color:#888; margin-top:10px;">SNSãƒªãƒ³ã‚¯ (ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›)</p>
            <input type="text" id="edit-twitter" placeholder="X (Twitter) ID">
            <input type="text" id="edit-insta" placeholder="Instagram ID">
            <input type="text" id="edit-threads" placeholder="Threads ID">

            <button class="btn btn-gold" onclick="saveProfile()">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>

    <div id="post-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1500; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; text-align:left;">
            <div class="modal-close" onclick="document.getElementById('post-modal').style.display='none'">Ã—</div>
            <h3 style="text-align:center; margin-top:0;">æ‚©ã¿ã‚’æŠ•ç¨¿</h3>
            <textarea id="post-content" rows="3" placeholder="ä¾‹ï¼šã‚¬ãƒãƒ£åˆ‡ã‚Šã•ã‚ŒãŸæ™‚ã®åˆ‡ã‚Šè¿”ã—ã¯ï¼Ÿ" style="width:100%; margin-bottom:10px;"></textarea>
            <textarea id="post-context" rows="2" placeholder="å‰ææ¡ä»¶ï¼ˆä»»æ„ï¼‰ä¾‹ï¼šãƒ†ãƒ¬ã‚¢ãƒã€ç¤¾é•·ç›¸æ‰‹" style="width:100%; margin-bottom:10px; background:#222; font-size:12px;"></textarea>
            <div style="margin-bottom:10px; font-size:12px; color:#888;">æ¥­ç¨®ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</div>
            <div class="tag-container" id="post-tags-container" style="margin-bottom:15px;"></div>
            <button class="btn btn-gold" onclick="submitPost()">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </div>

    <div id="answer-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1500; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; text-align:left;">
            <div class="modal-close" onclick="document.getElementById('answer-modal').style.display='none'">Ã—</div>
            <h3 style="text-align:center; margin-top:0;">å›ç­”ã‚’ä½œæˆ</h3>
            <textarea id="answer-content" rows="4" placeholder="ä¾‹ï¼šã€Œå·¦æ§˜ã§ã”ã–ã„ã¾ã—ãŸã‹ã€‚ãã‚Œã§ã¯æˆ»ã‚Šã®ãŠæ™‚é–“ã ã‘...ã€" style="width:100%; margin-bottom:10px;"></textarea>
            <textarea id="answer-reason" rows="3" placeholder="ç‹™ã„ãƒ»ç†ç”±" style="width:100%; margin-bottom:15px; background:#222; font-size:12px;"></textarea>
            <button class="btn btn-gold" onclick="submitAnswer()">å›ç­”ã‚’æŠ•ç¨¿</button>
        </div>
    </div>

    <div id="filter-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1500; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%;">
            <div class="modal-close" onclick="document.getElementById('filter-modal').style.display='none'">Ã—</div>
            <h3 style="margin-top:0;">æ¥­ç¨®ã§çµã‚Šè¾¼ã¿</h3>
            <div style="text-align:left; margin-bottom:15px;">
                <div id="filter-tags-container" style="display:flex; flex-wrap:wrap;"></div>
            </div>
            <button class="btn btn-gold" onclick="applyFilter()">é©ç”¨ã™ã‚‹</button>
            <button class="btn btn-outline" onclick="clearFilter()" style="margin-top:10px;">ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div id="payment-gateway-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:320px;">
            <div class="modal-close" onclick="document.getElementById('payment-gateway-modal').style.display='none'">Ã—</div>
            <h3>ğŸ’³ Secure Payment</h3>
            <p style="font-size:12px; color:#aaa; margin-bottom:20px;">ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯æš—å·åŒ–ã•ã‚Œã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯ãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚</p>
            
            <button class="btn btn-apple" onclick="processPaymentMock('Apple Pay')"></button>
            <div style="font-size:10px; color:#555; margin-bottom:10px;">ã¾ãŸã¯ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</div>
            
            <div class="secure-field">
                <span class="secure-icon">ğŸ’³</span>
                <input type="text" class="secure-input" placeholder="Card Number" value="4242 4242 4242 4242">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="secure-field" style="flex:1;">
                    <input type="text" class="secure-input" placeholder="MM/YY" value="12/30">
                </div>
                <div class="secure-field" style="flex:1;">
                    <input type="text" class="secure-input" placeholder="CVC" value="123">
                </div>
            </div>
            
            <button class="btn btn-gold" onclick="processPaymentMock('Credit Card')">Â¥ <span id="pay-amount">0</span> æ”¯æ‰•ã†</button>
            
            <div class="secure-note">
                <span>ğŸ”’ TLS 256-bit Encryption</span>
                <span>âœ… PCI DSS Compliant</span>
            </div>
        </div>
    </div>

    <div id="wallet-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2200; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:300px;">
            <div class="modal-close" onclick="document.getElementById('wallet-modal').style.display='none'">Ã—</div>
            <h3>ğŸª™ Coin Wallet</h3>
            <p style="font-size:24px; font-weight:bold; margin:10px 0;" id="wallet-balance-disp">0 Coins</p>
            <button class="btn btn-coin" onclick="initiateCoinPurchase(500, 500)">500 Coins (Â¥500) è³¼å…¥</button>
            <button class="btn btn-coin" onclick="initiateCoinPurchase(1100, 1000)">1,100 Coins (Â¥1,000) è³¼å…¥</button>
        </div>
    </div>

    <div id="system-plan-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:320px;">
            <div class="modal-close" onclick="document.getElementById('system-plan-modal').style.display='none'">Ã—</div>
            <h3>System Plans</h3>
            <button class="btn btn-standard" onclick="subscribeSystem('standard', 500)">Standard (500 Coins)</button>
            <button class="btn btn-premium" onclick="subscribeSystem('premium', 1000)">Premium (1,000 Coins)</button>
            <button class="btn btn-company" onclick="subscribeSystem('company', 30000)">Company (30,000 Coins)</button>
        </div>
    </div>

    <div id="creator-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:300px;">
            <div class="modal-close" onclick="document.getElementById('creator-modal').style.display='none'">Ã—</div>
            <h3>ğŸ™ï¸ è‡ªåˆ†ã®ã‚µãƒ–ã‚¹ã‚¯</h3>
            <select id="creator-status"><option value="off">åœæ­¢ä¸­</option><option value="on">å…¬é–‹ä¸­</option></select>
            <input type="number" id="creator-price" placeholder="æœˆé¡ (Coins)" style="margin-top:10px;">
            <button class="btn btn-gold" onclick="saveCreatorSettings()">ä¿å­˜</button>
        </div>
    </div>
    
    <div id="company-code-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2100; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:300px;">
            <div class="modal-close" onclick="document.getElementById('company-code-modal').style.display='none'">Ã—</div>
            <h3>ğŸ¢ ä¼šç¤¾ã‚³ãƒ¼ãƒ‰å…¥åŠ›</h3>
            <input type="text" id="company-code-input" placeholder="ä¾‹: 123">
            <button class="btn btn-company" onclick="verifyCompanyCode()">å‚åŠ </button>
        </div>
    </div>

    <div id="answer-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1600; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:300px;">
            <div class="modal-close" onclick="document.getElementById('answer-detail-modal').style.display='none'">Ã—</div>
            <h3>ğŸ“ å›ç­”å…¨æ–‡</h3>
            <div id="answer-detail-text"></div>
            <button class="btn btn-gold" id="btn-open-rating" onclick="openRatingModal()">è©•ä¾¡ã™ã‚‹</button>
        </div>
    </div>

    <div id="rating-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1700; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:300px;">
            <div class="modal-close" onclick="document.getElementById('rating-modal').style.display='none'">Ã—</div>
            <h3>ğŸ“Š è©³ç´°è©•ä¾¡</h3>
            <div class="rating-grid">
                <div class="rating-row"><span>è«–ç†æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="rate-logic" oninput="updateRateVal('logic', this.value)"><span id="val-logic" class="rating-val">3</span></div>
                <div class="rating-row"><span>å¿œç”¨æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="rate-tone" oninput="updateRateVal('tone', this.value)"><span id="val-tone" class="rating-val">3</span></div>
                <div class="rating-row"><span>å®Ÿç”¨æ€§</span><input type="range" min="1" max="5" value="3" class="rating-slider" id="rate-empathy" oninput="updateRateVal('empathy', this.value)"><span id="val-empathy" class="rating-val">3</span></div>
            </div>
            <button class="btn btn-gold" onclick="submitDetailRating()">é€ä¿¡</button>
        </div>
    </div>

    <div id="bookmarks-screen" class="screen">
        <div class="app-header">
            <div class="menu-btn" onclick="backToPrev()">â†</div>
            <div class="logo-btn" onclick="refreshApp()"><span class="logo-icon">ğŸ”‘</span><span class="logo-text" style="color:var(--accent);">Closer</span></div>
        </div>
        <div style="padding:15px; font-weight:bold; color:#888; display:flex; justify-content:space-between;">
            <span id="bookmark-header-text">ãƒã‚¤å˜èªå¸³</span>
            <span id="bookmark-count">0/5</span>
        </div>
        <div style="padding:0 15px;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="bookmark-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢" style="margin-bottom:10px;">
                <button class="btn btn-gold" style="width:auto; padding:0 15px; margin-bottom:10px;" onclick="renderBookmarks()">ğŸ”</button>
            </div>
        </div>
        <div class="content" id="bookmarks-list"></div>
    </div>

    <div id="notification-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1800; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:320px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-close" onclick="document.getElementById('notification-modal').style.display='none'">Ã—</div>
            <h3>ğŸ”” é€šçŸ¥ä¸€è¦§</h3>
            <div id="notification-list"></div>
        </div>
    </div>

    <div id="simple-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1900; align-items:center; justify-content:center;" onclick="if(event.target===this)this.style.display='none'">
        <div class="modal-card" style="width:90%; max-width:320px; text-align:left;">
            <div class="modal-close" onclick="document.getElementById('simple-modal').style.display='none'">Ã—</div>
            <h3 id="simple-modal-title"></h3>
            <div id="simple-modal-content" style="font-size:13px; color:#ccc; line-height:1.6;"></div>
        </div>
    </div>

    <script>
        const EMAILJS_PUBLIC_KEY = "UmvB6PSL-gQRkqubw"; 
        const EMAILJS_SERVICE_ID = "service_smgexjp"; 
        const EMAILJS_TEMPLATE_ID = "template_tcqq8jd";
        let generatedAuthCode = null; 
        (function() { emailjs.init(EMAILJS_PUBLIC_KEY); })();

        // ãƒ‡ãƒ¼ã‚¿å®šç¾©
        let dummyUsers = {
            'Fafa': { name: 'Fafa', role: 'Top Sales', history: 'é€šä¿¡10å¹´', rate: 0, img: '', bio: 'å–¶æ¥­ã¯ç§‘å­¦ã§ã™ã€‚', products: ['é€šä¿¡'], plan: 'free', savedAnswers: [], curiousItems: [], config:{}, mySubPrice: 500, mySubActive: true, coins: 0, scoutEnabled: true, isPro: true, subscriptions: [], social:{twitter:'fafa', insta:'', threads:''} },
            'Sato': { name: 'Sato', role: 'Manager', history: 'ä¸å‹•ç”£5å¹´', rate: 0, img: '', bio: 'æ°—åˆã¨æ ¹æ€§', products: ['ä¸å‹•ç”£'], plan: 'free', savedAnswers: [], curiousItems: [], config:{}, mySubPrice: 0, mySubActive: false, coins: 0, scoutEnabled: false, isPro: false, subscriptions: [], social:{} },
            'Suzuki': { name: 'Suzuki', role: 'Rookie', history: 'SaaS 1å¹´', rate: 0, img: '', bio: 'å‹‰å¼·ä¸­', products: ['SaaSãƒ»IT'], plan: 'free', savedAnswers: [], curiousItems: [], config:{}, mySubPrice: 0, mySubActive: false, coins: 0, scoutEnabled: true, isPro: false, subscriptions: [], social:{} },
            'Guest': { name: 'Guest', role: 'Visitor', history: '', rate: 0, img: '', bio: '', products: [], plan: 'free', savedAnswers: [], curiousItems: [], config:{}, mySubPrice: 0, mySubActive: false, coins: 0, scoutEnabled: false, isPro: false, subscriptions: [], social:{} }
        };
        let dummyPosts = [
            { id: 101, title: 'VSã€Œè³‡æ–™ã ã‘é€ã£ã¦ã€', context: 'ä¸­å°ä¼æ¥­ç¤¾é•·ã€ãƒ†ãƒ¬ã‚¢ãƒçµ‚ç›¤', tags: ['é€šä¿¡', 'ä¸­å°ä¼æ¥­'], time: '10åˆ†å‰', curiousCount: 120, userId: 'Fafa', companyId: null, isCurious: false },
            { id: 102, title: 'VSã€Œç¤¾é•·ã¯ä¸åœ¨ã§ã™ã€', context: '', tags: ['ä¸å‹•ç”£', 'å—ä»˜çªç ´'], time: '30åˆ†å‰', curiousCount: 85, userId: 'Sato', companyId: null, isCurious: false },
            { id: 103, title: 'ã€Œäºˆç®—ãŒãªã„ã€ã«å¯¾ã™ã‚‹åˆ‡ã‚Šè¿”ã—', context: 'å•†è«‡çµ‚ç›¤', tags: ['SaaSãƒ»IT'], time: '1æ™‚é–“å‰', curiousCount: 45, userId: 'Suzuki', companyId: null, isCurious: false }
        ];
        let dummyAnswers = [
            { id: 1, postId: 101, user: 'Fafa', isPremium: false, text: 'ã¾ãšã¯ç›¸æ‰‹ã®å¦å®šã‚’å—ã‘æ­¢ã‚ã€ã€Œãã†ã§ã™ã‚ˆã­ã€ã¨å…±æ„Ÿã—ã¦ã‹ã‚‰ã€ã€Œè³‡æ–™ã‚’é€ã‚‹å‰ã«ä¸€ç‚¹ã ã‘...ã€ã¨åˆ‡ã‚Šè¿”ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚¤ã‚¨ã‚¹ãƒ»ãƒãƒƒãƒˆæ³•ã®å¿œç”¨ã§ã™ã€‚', reason:'ã‚¤ã‚¨ã‚¹ãƒ»ãƒãƒƒãƒˆæ³•', votes: {1:0, 5:2}, detailedVotes: {logic:[5], tone:[4], empathy:[5]}, replies: [] },
            { id: 2, postId: 101, user: 'Sato', isPremium: true, text: 'ã€æœ‰æ–™ç´šã€‘æ±ºè£è€…ã«ç›´æ¥åˆºã•ã‚‹ã‚­ãƒ©ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º...', reason:'...', votes: {5:0}, detailedVotes: {logic:[], tone:[], empathy:[]}, replies: [] },
            { id: 3, postId: 102, user: 'Suzuki', isPremium: false, text: 'å…ƒæ°—ã‚ˆãæŒ¨æ‹¶ã—ã¦ã€æˆ»ã‚Šæ™‚é–“ã‚’èãï¼', reason:'å˜ç´”æ¥è§¦åŠ¹æœ', votes: {1:5}, detailedVotes: {logic:[], tone:[], empathy:[]}, replies: [] }
        ];
        let dummyNotifications = [
            { id: 1, type: 'reply', text: 'ã‚ãªãŸã®æŠ•ç¨¿ã«å›ç­”ãŒã¤ãã¾ã—ãŸ', time: '5åˆ†å‰', read: false, targetId: 101, isPost: true },
            { id: 2, type: 'scout', text: 'ä¼æ¥­ã‹ã‚‰ã‚¹ã‚«ã‚¦ãƒˆãŒå±Šã„ã¦ã„ã¾ã™', time: '1æ™‚é–“å‰', read: false, targetId: null },
            { id: 3, type: 'info', text: 'é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›ï¼šæ–°æ©Ÿèƒ½è¿½åŠ ', time: '1æ—¥å‰', read: true, targetId: null }
        ];
        
        const products = [
            "ä¸å‹•ç”£", "ä¿é™ºãƒ»é‡‘è", "é€šä¿¡ãƒ»OAæ©Ÿå™¨", "SaaSãƒ»IT", 
            "äººæ", "åºƒå‘Šãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢", "åŒ»ç™‚ãƒ»ä»‹è­·", "å»ºè¨­ãƒ»ãƒªãƒ•ã‚©ãƒ¼ãƒ ", 
            "M&A", "å£«æ¥­", "å¤ªé™½å…‰ãƒ»è“„é›»æ± ", "ãã®ä»–"
        ];
        
        let isGuest = true;
        let currentPostId = null;
        let currentFilters = [];
        let currentSort = 'new';
        let isCompanyMode = false;
        let pendingPayment = null; 
        let targetAnswerIdForRating = null;
        let selectedProductTags = [];
        let currentProfileTab = 'posts';
        let viewingProfileUser = null;
        let isCuriousView = false; // â˜…ã“ã‚Œã‚’è¿½åŠ 
        let navHistory = [];
        let scrollPositions = {};

        window.onload = function() {
            loadAllData();
            renderTags('product-tags', true);
            renderTags('post-tags-container', true);
            renderFilterTags();
            checkNotification(); 
            
            const savedUserSession = sessionStorage.getItem('closer_logged_in_user');
            if(savedUserSession) {
                const u = JSON.parse(savedUserSession);
                if(dummyUsers[u.name]) {
                    loginSuccess(u); // ã“ã“ã§ã‚¢ã‚¤ã‚³ãƒ³åæ˜ 
                } else {
                    startAsGuest();
                }
            }
        };

        function saveData() {
            localStorage.setItem('closer_data_posts', JSON.stringify(dummyPosts));
            localStorage.setItem('closer_data_answers', JSON.stringify(dummyAnswers));
            localStorage.setItem('closer_data_users', JSON.stringify(dummyUsers));
        }
        function loadAllData() {
            const p = localStorage.getItem('closer_data_posts');
            if(p) dummyPosts = JSON.parse(p);
            const a = localStorage.getItem('closer_data_answers');
            if(a) dummyAnswers = JSON.parse(a);
            const u = localStorage.getItem('closer_data_users');
            if(u) dummyUsers = JSON.parse(u);
        }

        function refreshApp() {
            // calculateAllUserRates(); // å‰Šé™¤: å®šç¾©ã•ã‚Œã¦ã„ãªã„é–¢æ•°ã®ãŸã‚ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹
            const current = document.querySelector('.screen.active');
            if(current) {
                if(current.id === 'timeline-screen') renderTimeline(isCuriousView);
                if(current.id === 'ranking-screen') renderRanking();
                if(current.id === 'user-ranking-screen') renderUserRanking();
                if(current.id === 'detail-screen') renderAnswers(currentPostId);
                if(current.id === 'bookmarks-screen') renderBookmarks();
                if(current.id === 'profile-screen') openProfile(viewingProfileUser || 'me'); // ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚ç¶­æŒ
            }
            // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ï¼ˆä¿®æ­£1ï¼‰
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            if(!isGuest && dummyUsers[myName] && dummyUsers[myName].img) {
                document.getElementById('menu-icon-img').src = dummyUsers[myName].img;
                document.getElementById('menu-icon-img').style.display = 'block';
                document.getElementById('menu-icon-placeholder').style.display = 'none';
            }
        }

        function navTo(screenId) {
            const current = document.querySelector('.screen.active');
            if(current) {
                scrollPositions[current.id] = current.scrollTop;
                if(navHistory[navHistory.length-1] !== current.id) navHistory.push(current.id);
            }
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
            const next = document.getElementById(screenId);
            next.classList.add('active');
            
            if(scrollPositions[screenId]) next.scrollTop = scrollPositions[screenId]; else next.scrollTop = 0;
            if(document.getElementById('side-menu').classList.contains('open')) toggleMenu();
            
            if(screenId === 'timeline-screen') renderTimeline(isCuriousView);
            if(screenId === 'bookmarks-screen') renderBookmarks();
            if(screenId === 'user-ranking-screen') renderUserRanking();
            if(screenId === 'ranking-screen') renderRanking();
            if(screenId === 'ai-practice-screen') loadAIScenarios();
            // è¨­å®šç”»é¢ã‚’é–‹ãã¨ãã«ãƒˆã‚°ãƒ«çŠ¶æ…‹ã‚’åæ˜ 
            if(screenId === 'settings-screen') loadSettingsToggles();
        }

        function backToPrev() {
            if(navHistory.length > 0) {
                const prev = navHistory.pop();
                navToNoPush(prev);
            } else {
                navToNoPush('timeline-screen');
            }
        }
        function navToNoPush(screenId) {
            const current = document.querySelector('.screen.active');
            if(current) scrollPositions[current.id] = current.scrollTop;
            document.querySelectorAll('.screen').forEach(x=>x.classList.remove('active'));
            const next = document.getElementById(screenId);
            next.classList.add('active');
            if(scrollPositions[screenId]) next.scrollTop = scrollPositions[screenId];
        }

        // --- ä¿®æ­£1: ç”»åƒåæ˜  (loginSuccess) ---
        function loginSuccess(u){ 
            isGuest=false; 
            sessionStorage.setItem('closer_logged_in_user', JSON.stringify(u)); 
            document.getElementById('menu-username').innerText=u.name; 
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
            if(u.img) {
                document.getElementById('menu-icon-img').src = u.img;
                document.getElementById('menu-icon-img').style.display = 'block';
                document.getElementById('menu-icon-placeholder').style.display = 'none';
            }
            refreshApp(); 
            navTo('timeline-screen'); 
        }

        // --- ä¿®æ­£2: ã€Œæ°—ã«ãªã‚‹ã€ãƒªã‚¹ãƒˆã®é©æ­£åŒ– ---
        function toggleCurious(postId) {
            if(isGuest) { alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return navTo('auth-screen'); }
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const post = dummyPosts.find(p => p.id === postId);
            
            if(!dummyUsers[myName].curiousItems) dummyUsers[myName].curiousItems = [];
            const idx = dummyUsers[myName].curiousItems.indexOf(postId);
            
            if(idx === -1) {
                dummyUsers[myName].curiousItems.push(postId);
                post.curiousCount++;
                post.isCurious = true; // è¡¨ç¤ºç”¨ãƒ•ãƒ©ã‚°ï¼ˆç°¡æ˜“ï¼‰
            } else {
                dummyUsers[myName].curiousItems.splice(idx, 1);
                post.curiousCount--;
                post.isCurious = false;
            }
            saveData();
            refreshApp(); // ãƒªã‚¹ãƒˆã‹ã‚‰å³åº§ã«æ¶ˆãˆã‚‹ï¼ˆrenderTimelineã®ãƒ•ã‚£ãƒ«ã‚¿ãŒåŠ¹ãï¼‰
        }

        function showCuriousList(){ 
            isCuriousView = true;
            const list = document.getElementById('timeline-list');
            list.innerHTML = '';
            document.getElementById('timeline-title').innerText = "æ°—ã«ãªã‚‹ãƒªã‚¹ãƒˆ";
            // ä¿®æ­£2: å¼•æ•°ã§ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            renderTimeline(true); 
            navTo('timeline-screen'); 
        }

        // --- ä¿®æ­£4: é€šçŸ¥è¨­å®šã®ä¿å­˜ ---
        function saveConfig() {
            if(isGuest) return;
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const u = dummyUsers[myName];
            u.config = {
                scout: document.getElementById('conf-scout').checked,
                curious: document.getElementById('conf-curious').checked,
                rate: document.getElementById('conf-rate').checked,
                rank: document.getElementById('conf-rank').checked,
                sub: document.getElementById('conf-sub').checked,
                admin: document.getElementById('conf-admin').checked
            };
            saveData();
        }
        function loadSettingsToggles() {
            if(isGuest) return;
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const c = dummyUsers[myName].config || {};
            document.getElementById('conf-scout').checked = c.scout || false;
            document.getElementById('conf-curious').checked = c.curious || false;
            document.getElementById('conf-rate').checked = c.rate || false;
            document.getElementById('conf-rank').checked = c.rank || false;
            document.getElementById('conf-sub').checked = c.sub || false;
            document.getElementById('conf-admin').checked = c.admin || false;
        }

        // --- ä¿®æ­£5: ã‚µãƒ–ã‚¹ã‚¯ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ãƒ»ãƒãƒ£ãƒƒãƒˆ ---
       function openProfile(userId) {
            let u;
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            viewingProfileUser = userId === 'me' ? myName : userId;

            // ã‚²ã‚¹ãƒˆãŒã€Œè‡ªåˆ†(me)ã€ã‚’é–‹ã“ã†ã¨ã—ãŸæ™‚ã ã‘ãƒ­ã‚°ã‚¤ãƒ³ã¸èª˜å°
            if(userId === 'me' && isGuest) {
                return navTo('auth-screen');
            }

            if(isCompanyMode && userId !== 'me' && userId !== myName) {
                const realUser = dummyUsers[userId];
                u = { ...realUser };
                u.name = `å€™è£œè€… (Rank ${parseFloat(u.rate) > 4.0 ? 'S' : 'A'})`;
                u.isAnonymous = true; 
            } else {
                u = dummyUsers[viewingProfileUser];
            }
            
            if(!u) return;

            document.getElementById('prof-name').innerHTML = u.name + (u.isPro ? ' <span class="pro-badge">PRO</span>' : '');
            document.getElementById('prof-role').innerText = `${u.role || '--'}`;
            document.getElementById('prof-rate').innerText = u.rate || '0.00';
            if(u.img) document.getElementById('prof-img').src = u.img;
            
            const socialArea = document.getElementById('prof-social');
            socialArea.innerHTML = '';
            if(!u.isAnonymous && u.social) {
                if(u.social.twitter) socialArea.innerHTML += `<a href="https://twitter.com/${u.social.twitter}" target="_blank" class="social-icon">ğ•</a>`;
                if(u.social.insta) socialArea.innerHTML += `<a href="https://instagram.com/${u.social.insta}" target="_blank" class="social-icon">ğŸ“¸</a>`;
                if(u.social.threads) socialArea.innerHTML += `<a href="https://threads.net/@${u.social.threads}" target="_blank" class="social-icon">ğŸ§µ</a>`;
            }

            const actionArea = document.getElementById('prof-action-area');
            actionArea.innerHTML = '';
            
            // ã‚µãƒ–ã‚¹ã‚¯ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®š
            if(!u.isAnonymous && userId !== 'me' && u.mySubActive) {
                const mySubs = (dummyUsers[myName] && dummyUsers[myName].subscriptions) ? dummyUsers[myName].subscriptions : [];
                const isSubscribed = mySubs.includes(dummyUsers[userId].name);
                
                if(isSubscribed) {
                    const leaveBtn = document.createElement('button');
                    leaveBtn.className = 'btn btn-danger btn-sm';
                    leaveBtn.style.marginTop = '10px';
                    leaveBtn.innerText = 'é€€ä¼šã™ã‚‹';
                    leaveBtn.onclick = function() { leaveUserSub(dummyUsers[userId].name); };
                    actionArea.appendChild(leaveBtn);
                } else {
                    const subBtn = document.createElement('button');
                    subBtn.className = 'btn btn-premium';
                    subBtn.innerText = `â˜… ${u.name}ã®ã‚µãƒ–ã‚¹ã‚¯ (${u.mySubPrice} Coins/æœˆ)`;
                    subBtn.onclick = function() { unlockUserSub(dummyUsers[userId].name); };
                    actionArea.appendChild(subBtn);
                }
            }
            
            if(userId === 'me') {
                document.getElementById('prof-coin-display').style.display = 'block';
                document.getElementById('prof-coin-display').innerText = `ğŸª™ ${u.coins} Coins`;
            } else {
                document.getElementById('prof-coin-display').style.display = 'none';
            }

            renderProfileContent(viewingProfileUser);
            navTo('profile-screen');
        }

        function switchProfileTab(tab) {
            currentProfileTab = tab;
            document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-prof-' + tab).classList.add('active');
            renderProfileContent(viewingProfileUser);
        }

        function renderProfileContent(targetUserId) {
            const area = document.getElementById('prof-content-area');
            area.innerHTML = '';
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const isMe = (targetUserId === myName);
            // ã‚µãƒ–ã‚¹ã‚¯åˆ¤å®š
            const isSubscribed = isMe || (dummyUsers[myName].subscriptions && dummyUsers[myName].subscriptions.includes(targetUserId));

            if(currentProfileTab === 'posts') {
                // æŠ•ç¨¿ä¸€è¦§ï¼ˆã‚µãƒ–ã‚¹ã‚¯é™å®šå«ã‚€ï¼‰
                const userPosts = dummyAnswers.filter(a => a.user === targetUserId); // æœ¬æ¥ã¯"æŠ•ç¨¿"ã ãŒä»•æ§˜ä¸ŠAnswerãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã®ã§Answerã‚’è¡¨ç¤º
                userPosts.forEach(ans => {
                    const div = document.createElement('div');
                    div.className = 'answer-card';
                    let content = ans.text;
                    // ã¼ã‹ã—å‡¦ç†
                    if(ans.isPremium && !isSubscribed) {
                        div.innerHTML = `<div class="blur-content">${content}</div><div style="text-align:center; color:var(--accent); font-size:12px; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">ğŸ”’ ã‚µãƒ–ã‚¹ã‚¯é™å®š</div>`;
                        div.style.position = 'relative';
                    } else {
                        div.innerHTML = `<div class="answer-body">${content}</div>`;
                    }
                    area.appendChild(div);
                });
            } else if(currentProfileTab === 'chat') {
                // ãƒãƒ£ãƒƒãƒˆ
                const container = document.createElement('div');
                container.className = 'dm-container';
                
                // ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã€å¸¸ã«UIã‚’è¡¨ç¤º
                container.innerHTML = `
                    <div id="dm-history" style="flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
                        <div style="background:#333; padding:10px; border-radius:12px; align-self:flex-start; max-width:80%; font-size:14px;">
                            ${targetUserId}ã•ã‚“ã¸ã®ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸<br>
                            <span style="font-size:11px; color:#888;">â€»æœªåŠ å…¥ã®å ´åˆã€é€ä¿¡æ™‚ã«åŠ å…¥æ‰‹ç¶šããŒå¿…è¦ã§ã™ã€‚</span>
                        </div>
                    </div>
                    <div style="padding:10px; background:#222; display:flex; border-top:1px solid #333;">
                        <input type="text" id="dm-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="margin:0; flex:1;">
                        <button class="btn btn-gold" style="width:60px; margin:0 0 0 10px;" onclick="checkAndSendDM('${targetUserId}')">é€ä¿¡</button>
                    </div>
                `;
                area.appendChild(container);
            }
        }

        function leaveUserSub(targetUser) {
            if(!confirm("é€€ä¼šã—ã¾ã™ã‹ï¼Ÿ")) return;
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const idx = dummyUsers[myName].subscriptions.indexOf(targetUser);
            if(idx > -1) {
                dummyUsers[myName].subscriptions.splice(idx, 1);
                saveData();
                alert("é€€ä¼šã—ã¾ã—ãŸ");
                openProfile(targetUser); // å†æç”»
            }
        }

        // --- ä¿®æ­£6: ãŠå•ã„åˆã‚ã›ã‚¿ã‚¤ãƒ—é¸æŠ ---
        function selectContactType(btn) {
            document.querySelectorAll('#contact-screen .btn-outline').forEach(b => b.style.borderColor = 'var(--text-sub)');
            btn.style.borderColor = 'var(--accent)';
            btn.style.color = 'var(--accent)';
        }

        // æ—¢å­˜é–¢æ•°ç¾¤ã®å¾®ä¿®æ­£ï¼ˆrenderTimelineã®ãƒ•ã‚£ãƒ«ã‚¿ãªã©ï¼‰
        function renderTimeline(showCuriousListMode = false, searchKeyword = null) {
            const list = document.getElementById('timeline-list');
            list.innerHTML = '';
            if(!showCuriousListMode) document.getElementById('timeline-title').innerText = "æ–°ç€ã®æ‚©ã¿";
            
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            // ä¿®æ­£2: è‡ªåˆ†ã®ãƒªã‚¹ãƒˆã«åŸºã¥ããƒ•ã‚£ãƒ«ã‚¿
            const myCuriousIds = (dummyUsers[myName] && dummyUsers[myName].curiousItems) ? dummyUsers[myName].curiousItems : [];

            let filteredPosts = dummyPosts.filter(p => {
                if(isCompanyMode && p.companyId !== 'CORP123') return false; 
                if(!isCompanyMode && p.companyId !== null) return false;
                // ä¿®æ­£2: ãƒ•ãƒ©ã‚°ã§ã¯ãªããƒªã‚¹ãƒˆã«å«ã¾ã‚Œã‚‹ã‹ã§åˆ¤å®š
                if(showCuriousListMode && !myCuriousIds.includes(p.id)) return false;
                
                if(currentFilters.length > 0 && !p.tags.some(tag => currentFilters.includes(tag))) return false;
                if(searchKeyword) {
                    const k = searchKeyword.toLowerCase();
                    if(!p.title.toLowerCase().includes(k) && !p.tags.some(t => t.toLowerCase().includes(k))) return false;
                }
                return true;
            });

            // ã‚½ãƒ¼ãƒˆ
            if(currentSort === 'popular') filteredPosts.sort((a,b) => b.curiousCount - a.curiousCount);
            if(currentSort === 'unanswered') filteredPosts = filteredPosts.filter(p => !dummyAnswers.some(a => a.postId === p.id));
            
            if(filteredPosts.length === 0) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }

            filteredPosts.forEach(p => {
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => openDetail(p.id);
                
                let deleteBtn = '';
                if(p.userId === myName) {
                    deleteBtn = `<button class="btn-icon-sm delete" onclick="event.stopPropagation(); deletePost(${p.id})">ğŸ—‘ï¸</button>`;
                }
                
                const isMe = (p.userId === myName);
                const isCurious = myCuriousIds.includes(p.id); // è‡ªåˆ†ã®çŠ¶æ…‹
                const curiousClick = isMe ? "event.stopPropagation(); alert('è‡ªåˆ†ã®æŠ•ç¨¿ã§ã™');" : `event.stopPropagation(); toggleCurious(${p.id})`;
                const curiousClass = isMe ? "action-item disabled" : `action-item ${isCurious?'active':''}`;

                div.innerHTML = `
                    <div class="card-meta"><span>${p.time}</span><div class="card-user" onclick="event.stopPropagation(); openProfile('${p.userId}')">ğŸ‘¤ ${p.userId}</div></div>
                    <div class="q-title">${p.title}</div>
                    <div class="tags">${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
                    <div class="card-actions">
                         <div class="${curiousClass}" onclick="${curiousClick}">ğŸ¤” (${p.curiousCount})</div>
                         <div class="action-item" onclick="event.stopPropagation(); openAnswerModal(${p.id})">ğŸ’¬ å›ç­”</div>
                         <div style="display:flex; align-items:center; justify-content:flex-end; flex:1;">${deleteBtn}</div>
                    </div>`;
                list.appendChild(div);
            });
        }

        // --- ãã®ä»–ã®å¿…é ˆé–¢æ•° ---
        function checkDeviceAndSendCode() {
            const email = document.getElementById('reg-email').value;
            if(!email) return alert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(localStorage.getItem('closer_device_registered')) { alert("ã“ã®ç«¯æœ«ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ã—ã¾ã™ã€‚"); switchAuthTab('login'); return; }
            generatedAuthCode = Math.floor(1000 + Math.random() * 9000).toString();
            console.log("Debug Code:", generatedAuthCode);
            const btn = event.target; const originalText = btn.innerText; btn.innerText = "é€ä¿¡ä¸­..."; btn.disabled = true;
            emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, { to_email: email, code: generatedAuthCode })
            .then(() => { alert(`èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`); document.getElementById('reg-step-1').style.display = 'none'; document.getElementById('reg-step-2').style.display = 'block'; }, 
            (err) => { alert("é€ä¿¡å¤±æ•—: " + JSON.stringify(err)); btn.innerText = originalText; btn.disabled = false; });
        }
        function verifyCode() { if(document.getElementById('reg-code').value === generatedAuthCode) { document.getElementById('reg-step-2').style.display = 'none'; document.getElementById('reg-step-3').style.display = 'block'; } else alert("ã‚³ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™"); }
        function goToBioStep() { if(!document.getElementById('reg-name').value || !document.getElementById('reg-pass').value) return alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); document.getElementById('reg-step-3').style.display = 'none'; document.getElementById('reg-step-4').style.display = 'block'; }
        function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { document.getElementById('avatar-preview').style.display = 'none'; document.getElementById('avatar-img').src = e.target.result; document.getElementById('avatar-img').style.display = 'block'; }; reader.readAsDataURL(input.files[0]); } }
        function completeRegistration(){ const name = document.getElementById('reg-name').value; const u = { name: name, email: document.getElementById('reg-email').value, password: document.getElementById('reg-pass').value, role: 'Newcomer', rate: '0.00', coins: 0, subscriptions: [], savedAnswers: [], products: selectedProductTags, img: document.getElementById('avatar-img').src, social: {}, curiousItems:[], config:{} }; dummyUsers[name] = u; localStorage.setItem('closer_device_registered', 'true'); saveData(); loginSuccess(u); }
        function doLogin(){ 
            loadAllData(); 
            const inputVal = document.getElementById('login-email').value; 
            const passVal = document.getElementById('login-pass').value;
            const users = Object.values(dummyUsers); 
            
            // ä¿®æ­£: å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ« ã¾ãŸã¯ åå‰ ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¢ã™
            const u = users.find(u => (u.email === inputVal || u.name === inputVal) && u.name !== 'Guest'); 
            
            if(u) {
                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã™ã‚‹
                if(u.password && u.password !== passVal) {
                    return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                }
                loginSuccess(u); 
            } else {
                alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); 
            }
        }
        function startAsGuest(){ isGuest=true; sessionStorage.removeItem('closer_logged_in_user'); refreshApp(); navTo('timeline-screen'); }
        function renderTags(elementId, isSelectable = false) { const container = document.getElementById(elementId); container.innerHTML = ''; products.forEach(p => { const tag = document.createElement('div'); tag.className = 'choice-tag'; tag.innerText = p; if(isSelectable) { tag.onclick = function() { this.classList.toggle('selected'); if(elementId === 'product-tags') { if(this.classList.contains('selected')) selectedProductTags.push(p); else selectedProductTags = selectedProductTags.filter(t => t !== p); } }; } container.appendChild(tag); }); }
        
        // MISSING FUNCTIONS ADDED BELOW
        function renderFilterTags() {
            const container = document.getElementById('filter-tags-container');
            container.innerHTML = '';
            products.forEach(prod => {
                const tag = document.createElement('div');
                tag.className = 'filter-tag';
                tag.innerText = prod;
                if(currentFilters.includes(prod)) tag.classList.add('selected');
                tag.onclick = function() { this.classList.toggle('selected'); };
                container.appendChild(tag);
            });
        }
        function openFilterModal() { renderFilterTags(); document.getElementById('filter-modal').style.display = 'flex'; }
        function applyFilter() {
            currentFilters = Array.from(document.querySelectorAll('#filter-tags-container .filter-tag.selected')).map(el => el.innerText);
            renderTimeline();
            document.getElementById('filter-modal').style.display = 'none';
        }
        function clearFilter() { currentFilters = []; renderTimeline(); document.getElementById('filter-modal').style.display = 'none'; }
        function setSort(type) {
            currentSort = type;
            document.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('active'));
            document.getElementById('sort-'+type).classList.add('active');
            renderTimeline();
        }
        function performSearch(keyword) {
            currentFilters = []; 
            document.getElementById('filter-tags-container').innerHTML = '';
            renderTimeline(false, keyword);
            navTo('timeline-screen');
        }
        function randomizeTimeline() {
            dummyPosts.sort(() => Math.random() - 0.5);
            renderTimeline();
        }
        function loadAIScenarios() {
            const select = document.getElementById('ai-scenario-select');
            select.innerHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç†ä¸å°½ãªå®¢ï¼‰</option>';
            if(isGuest) return;
            
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const savedIds = dummyUsers[myName].savedAnswers || [];
            
            savedIds.forEach(id => {
                const ans = dummyAnswers.find(x => x.id === id);
                if(ans) {
                    const opt = document.createElement('option');
                    opt.value = ans.text;
                    opt.innerText = ans.text.substring(0, 20) + "...";
                    select.appendChild(opt);
                }
            });
        }

      /* --- ä¿®æ­£ç‰ˆ: ã‚µãƒ–ã‚¹ã‚¯è§£é™¤ãƒ»åŠ å…¥ãƒ­ã‚¸ãƒƒã‚¯ --- */
        function unlockUserSub(targetUser) {
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´ã—ã€åˆ†å²å‡¦ç†ã‚’è¿½åŠ 
            if(confirm(`${targetUser}ã•ã‚“ã®ã‚µãƒ–ã‚¹ã‚¯åŠ å…¥è€…é™å®šã§ã™ã€‚åŠ å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                if(isGuest) {
                    // æœªãƒ­ã‚°ã‚¤ãƒ³ -> ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                    return navTo('auth-screen');
                }
                
                // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ -> æ±ºæ¸ˆç¢ºèªã¸
                const cost = dummyUsers[targetUser].mySubPrice;
                const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
                
                if(dummyUsers[myName].coins < cost) {
                    alert("ã‚³ã‚¤ãƒ³ä¸è¶³ã§ã™ã€‚ã‚³ã‚¤ãƒ³ã‚’è³¼å…¥ã—ã¦ãã ã•ã„ã€‚");
                    openWalletModal();
                    return;
                }
                
                if(confirm(`æœˆé¡ ${cost} Coins ã‚’æ¶ˆè²»ã—ã¦åŠ å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    dummyUsers[myName].coins -= cost;
                    if(!dummyUsers[myName].subscriptions) dummyUsers[myName].subscriptions = [];
                    dummyUsers[myName].subscriptions.push(targetUser);
                    saveData();
                    alert("åŠ å…¥ã—ã¾ã—ãŸï¼");
                    openProfile(targetUser); // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸ç§»å‹•ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
                }
            }
        }

        function renderAnswers(postId) { 
            const list = document.getElementById('answer-list'); 
            list.innerHTML = ''; 
            const postAnswers = dummyAnswers.filter(a => a.postId === postId); 
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name; 
            
            postAnswers.forEach(ans => { 
                const div = document.createElement('div'); 
                div.className = 'answer-card'; 
                let isUnlocked = false; 
                if(!isGuest) { 
                    if(ans.user === myName) isUnlocked = true; 
                    if(dummyUsers[myName].subscriptions && dummyUsers[myName].subscriptions.includes(ans.user)) isUnlocked = true; 
                } 
                
                const u = dummyUsers[ans.user] || dummyUsers['Guest']; 
                let content = ''; 
                
                if(ans.isPremium && !isUnlocked) { 
                    // ãƒ­ãƒƒã‚¯è¡¨ç¤º
                    content = `<div class="blur-content">${ans.text}</div><div class="locked-overlay"><span style="font-size:30px;">ğŸ”’</span><button class="btn btn-premium" style="width:auto; margin-top:10px; font-size:12px; padding:5px 15px;" onclick="event.stopPropagation(); unlockUserSub('${ans.user}')">è§£é™¤</button></div>`; 
                } else { 
                    content = `<div class="answer-body">${ans.text}</div><div class="answer-reason">ğŸ’¡ ${ans.reason}</div>`; 
                } 
                
                div.onclick = () => openAnswerDetail(ans.id); 
                
                let repliesHtml = ''; 
                if(ans.replies && ans.replies.length > 0) ans.replies.forEach(rep => repliesHtml += `<div class="reply-box"><div class="reply-header">â†ª ${rep.user}</div><div>${rep.text}</div></div>`); 
                
                const replyBtn = `<span style="font-size:11px; margin-left:10px; cursor:pointer; color:#888;" onclick="event.stopPropagation(); openReplyInput(${ans.id})">â†© è¿”ä¿¡</span>`; 
                const deleteBtn = (ans.user === myName) ? `<span style="font-size:11px; margin-left:10px; cursor:pointer; color:var(--danger);" onclick="event.stopPropagation(); deleteAnswer(${ans.id})">ğŸ—‘ï¸ å‰Šé™¤</span>` : ''; 
                
                const isSaved = !isGuest && dummyUsers[myName].savedAnswers && dummyUsers[myName].savedAnswers.includes(ans.id); 
                const saveBtn = (ans.user === myName) ? `<button class="btn-icon-sm disabled" onclick="event.stopPropagation(); alert('è‡ªåˆ†ã®å›ç­”ã§ã™')">ğŸ”– ä¿å­˜</button>` : `<button class="btn-icon-sm save ${isSaved?'saved':''}" onclick="event.stopPropagation(); toggleSaveAnswer(${ans.id})">${isSaved?'ğŸ”– ä¿å­˜æ¸ˆ':'ğŸ”– ä¿å­˜'}</button>`; 
                
                div.innerHTML = `<div class="answer-header"><div class="answer-author" onclick="event.stopPropagation(); openProfile('${ans.user}')">ğŸ‘¤ ${ans.user} ${u.isPro?'<span class="pro-badge">PRO</span>':''}</div><div style="display:flex; align-items:center;">${saveBtn}${replyBtn}${deleteBtn}</div></div><div style="position:relative;">${content}</div><div id="reply-area-${ans.id}">${repliesHtml}</div><div id="reply-input-${ans.id}" style="display:none; margin-top:10px;" onclick="event.stopPropagation()"><input type="text" id="reply-text-${ans.id}" placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..." style="margin-bottom:5px;"><button class="btn btn-gold" style="padding:8px; font-size:12px;" onclick="submitReply(${ans.id})">é€ä¿¡</button></div>`; 
                list.appendChild(div); 
            }); 
        }

        function openAnswerDetail(ansId) {
            currentViewingAnswerId = ansId;
            const ans = dummyAnswers.find(a => a.id === ansId);
            if(!ans) return;

            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            
            // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ å›ç­”ã®ãƒ­ãƒƒã‚¯åˆ¤å®š
            if(ans.isPremium) {
                if(isGuest || (ans.user !== myName && (!dummyUsers[myName].subscriptions || !dummyUsers[myName].subscriptions.includes(ans.user)))) {
                    
                    // ã‚µãƒ–ã‚¹ã‚¯èª˜å°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                    if(confirm(`${ans.user}ã•ã‚“ã®ã‚µãƒ–ã‚¹ã‚¯åŠ å…¥è€…é™å®šã§ã™ã€‚åŠ å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        if(isGuest) {
                            navTo('auth-screen');
                        } else {
                            unlockUserSub(ans.user);
                        }
                    }
                    return; 
                }
            }

            document.getElementById('view-ans-text').innerText = ans.text;
            document.getElementById('view-ans-reason').innerText = ans.reason || 'ï¼ˆè¨˜è¼‰ãªã—ï¼‰';

            const u = dummyUsers[myName] || {};
            if(!u.votedAnswers) u.votedAnswers = [];
            const hasVoted = u.votedAnswers.includes(ansId) || ans.user === myName;

            if(hasVoted) showRatingResult(ans);
            else showRatingInput();

            navTo('answer-view-screen');
        }

        function checkNotification() { const hasUnread = dummyNotifications.some(n => !n.read); if(hasUnread) { document.getElementById('badge-timeline').classList.add('active'); document.getElementById('badge-ranking').classList.add('active'); } }
        function toggleNotification() { 
            const modal = document.getElementById('notification-modal'); 
            const list = document.getElementById('notification-list'); 
            list.innerHTML = ''; 
            
            dummyNotifications.forEach(n => { 
                const item = document.createElement('div'); 
                item.className = 'notification-item'; 
                let icon = 'ğŸ””'; 
                if(n.type === 'reply') icon = 'ğŸ’¬'; 
                if(n.type === 'scout') icon = 'ğŸš€'; 
                
                item.innerHTML = `<div class="notif-icon">${icon}</div><div class="notif-content"><div>${n.text}</div><div class="notif-time">${n.time}</div></div>`; 
                
                item.onclick = () => { 
                    document.getElementById('notification-modal').style.display='none'; 
                    // â˜…ä¿®æ­£: ã‚¹ã‚«ã‚¦ãƒˆé€šçŸ¥ãªã‚‰ã‚¹ã‚«ã‚¦ãƒˆç”»é¢ã¸é·ç§»
                    if(n.type === 'scout') {
                        navTo('scout-screen');
                    } else if(n.isPost && n.targetId) {
                        openDetail(n.targetId); 
                    }
                }; 
                list.appendChild(item); 
            }); 
            modal.style.display = 'flex'; 
        }
        function verifyCompanyCode(){ if(document.getElementById('company-code-input').value==='123'){ isCompanyMode=true; companyId='CORP123'; alert("å‚åŠ ã—ã¾ã—ãŸ"); document.getElementById('company-code-modal').style.display='none'; refreshApp(); } else alert("ç„¡åŠ¹ã§ã™"); }
        function logout(){ sessionStorage.removeItem('closer_logged_in_user'); location.reload(); }
        function requestAccountDeletion(){ localStorage.removeItem('closer_data_users'); location.reload(); }
        function toggleMenu(){ document.getElementById('side-menu').classList.toggle('open'); document.getElementById('menu-overlay').classList.toggle('open'); }
        function switchAuthTab(m){ document.getElementById('auth-flow-register').style.display=m==='register'?'block':'none'; document.getElementById('auth-flow-login').style.display=m==='login'?'block':'none'; }
        function openRatingModal() { document.getElementById('answer-detail-modal').style.display = 'none'; document.getElementById('rating-modal').style.display = 'flex'; }
        function updateRateVal(type, val) { document.getElementById('val-'+type).innerText = val; }
        function submitDetailRating() { alert("è©•ä¾¡ã‚’é€ä¿¡ã—ã¾ã—ãŸ"); document.getElementById('rating-modal').style.display = 'none'; }
        
        /* --- ä¿®æ­£ç‰ˆ: å›ç­”ä¿å­˜ï¼ˆã‚²ã‚¹ãƒˆå¯¾å¿œï¼‰ --- */
        function toggleSaveAnswer(ansId) {
            if(isGuest) { alert("ä¿å­˜æ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return navTo('auth-screen'); }
            
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name; 
            const u = dummyUsers[myName]; 
            if(!u.savedAnswers) u.savedAnswers=[]; 
            const idx=u.savedAnswers.indexOf(ansId); 
            if(idx===-1){ u.savedAnswers.push(ansId); alert("ä¿å­˜ã—ã¾ã—ãŸ"); } 
            else { u.savedAnswers.splice(idx,1); alert("è§£é™¤ã—ã¾ã—ãŸ"); } 
            saveData(); 
            refreshApp(); 
        }

        function deletePost(id){ if(!confirm("å‰Šé™¤?"))return; dummyPosts=dummyPosts.filter(p=>p.id!==id); saveData(); refreshApp(); }
        function deleteAnswer(id){ if(!confirm("å‰Šé™¤?"))return; dummyAnswers=dummyAnswers.filter(a=>a.id!==id); saveData(); refreshApp(); }
        function openPostModal(){ document.getElementById('post-modal').style.display='flex'; }
        function openAnswerModal(id){ currentPostId=id; document.getElementById('answer-modal').style.display='flex'; }
        function openWalletModal(){ document.getElementById('wallet-modal').style.display='flex'; }
        function openSystemPlanModal(){ document.getElementById('system-plan-modal').style.display='flex'; }
        function openCreatorModal(){ document.getElementById('creator-modal').style.display='flex'; }
        function openProfileEdit(){ navTo('profile-edit-screen'); }
        function previewEditImage(input){ /* å‰ã¨åŒã˜ */ }
        function submitPost(){ const t=document.getElementById('post-content').value; dummyPosts.unshift({id:Date.now(), title:t, tags:['ãã®ä»–'], time:'Now', curiousCount:0, userId:JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name, companyId:null, isCurious: false}); saveData(); refreshApp(); document.getElementById('post-modal').style.display='none'; }
        
        function submitAnswer(){ 
            const t=document.getElementById('answer-content').value; 
            if(!t) return;
            const myName = isGuest ? 'Guest' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            dummyAnswers.push({
                id:Date.now(), 
                postId:currentPostId, 
                user:myName, 
                text:t, 
                reason:document.getElementById('answer-reason').value, 
                votes:{}, 
                isPremium:false, 
                replies:[]
            }); 
            saveData(); 
            refreshApp(); 
            document.getElementById('answer-modal').style.display='none'; 
        }

        function menuAction(screenId, isProfile=false) {
            if(document.getElementById('side-menu').classList.contains('open')) toggleMenu();
            if(isProfile) {
                if(isGuest) { alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return navTo('auth-screen'); }
                const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
                openProfile(myName);
            } else {
                if(screenId === 'timeline-screen') isCuriousView = false;
                navTo(screenId);
            }
        }

        function checkMemberAccess(screenId, type) {
            if(isGuest) {
                alert("ä¼šå“¡é™å®šæ©Ÿèƒ½ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                return navTo('auth-screen');
            }
            if(type === 'company') {
                document.getElementById('company-code-modal').style.display = 'flex';
                toggleMenu();
                return;
            }
            if(type === 'post') {
                openPostModal();
                return;
            }
            if(screenId) {
                if(document.getElementById('side-menu').classList.contains('open')) toggleMenu();
                navTo(screenId);
            }
        }

        function openDetail(postId) {
            currentPostId = postId;
            const p = dummyPosts.find(x => x.id === postId);
            if(!p) return;
            document.getElementById('detail-title').innerText = p.title;
            const ctxDiv = document.getElementById('detail-context');
            ctxDiv.innerText = p.context;
            ctxDiv.style.display = p.context ? 'block' : 'none';
            document.getElementById('detail-tags').innerHTML = p.tags.map(t=>`<span class="tag">${t}</span>`).join('');
            renderAnswers(postId);
            navTo('detail-screen');
        }

        function renderRanking() {
            const list = document.getElementById('ranking-list');
            list.innerHTML = '';
            const sorted = [...dummyPosts].sort((a,b) => b.curiousCount - a.curiousCount);
            sorted.forEach((p, idx) => {
                if(idx >= 10) return;
                const div = document.createElement('div');
                div.className = 'user-card';
                div.innerHTML = `<div class="user-card-left"><div class="user-rank-num ${idx<3?'top3':''}">${idx+1}</div><div><div style="font-weight:bold;">${p.title}</div><div style="font-size:12px; color:#888;">ğŸ¤” ${p.curiousCount} Curious</div></div></div>`;
                div.onclick = () => openDetail(p.id);
                list.appendChild(div);
            });
        }

        function renderUserRanking() {
            calculateAllUserRates();
            const list = document.getElementById('user-ranking-list');
            list.innerHTML = '';
            const users = Object.values(dummyUsers).filter(u => u.name !== 'Guest');
            users.sort((a,b) => parseFloat(b.rate) - parseFloat(a.rate));
            users.forEach((u, idx) => {
                const div = document.createElement('div');
                div.className = 'user-card';
                div.innerHTML = `<div class="user-card-left"><div class="user-rank-num ${idx<3?'top3':''}">${idx+1}</div><img src="${u.img||''}" class="user-mini-icon" style="width:30px;height:30px;"><div><div style="font-weight:bold;">${u.name}</div><div style="font-size:11px; color:#888;">${u.role}</div></div></div><div class="user-score">${u.rate}</div>`;
                div.onclick = () => openProfile(u.name);
                list.appendChild(div);
            });
        }

        function calculateAllUserRates() {
            Object.values(dummyUsers).forEach(u => {
                let score = 0;
                const myAnswers = dummyAnswers.filter(a => a.user === u.name);
                if(myAnswers.length > 0) {
                    const totalVotes = myAnswers.reduce((acc, cur) => {
                        let voteSum = 0;
                        if(cur.votes) {
                            for(let k in cur.votes) voteSum += parseInt(k) * cur.votes[k];
                        }
                        return acc + voteSum;
                    }, 0);
                    // ç°¡æ˜“è¨ˆç®—
                    score = (totalVotes / myAnswers.length).toFixed(2);
                }
                u.rate = score;
            });
        }

        function renderBookmarks() {
            const list = document.getElementById('bookmarks-list');
            list.innerHTML = '';
            const myName = isGuest ? '' : JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            if(isGuest) return;
            const savedIds = dummyUsers[myName].savedAnswers || [];
            document.getElementById('bookmark-count').innerText = `${savedIds.length} items`;
            
            savedIds.forEach(id => {
                const ans = dummyAnswers.find(a => a.id === id);
                if(ans) {
                    const div = document.createElement('div');
                    div.className = 'answer-card';
                    div.innerHTML = `<div class="answer-header"><div class="answer-author">${ans.user}</div></div><div class="answer-body">${ans.text}</div><button class="btn-sm btn-outline" onclick="openDetail(${ans.postId})">å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹</button>`;
                    list.appendChild(div);
                }
            });
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const txt = input.value;
            if(!txt) return;
            const area = document.getElementById('ai-chat-area');
            area.innerHTML += `<div class="chat-bubble bubble-user">${txt}</div>`;
            input.value = '';
            area.scrollTop = area.scrollHeight;
            setTimeout(() => {
                const replies = ["ãªã‚‹ã»ã©ã€ãã‚Œã§ï¼Ÿ", "é«˜ã„ã­ã€‚", "æ¤œè¨ã—ã¾ã™ã€‚", "èˆˆå‘³ãªã„ã‹ãªã€‚", "ä»–ç¤¾ã¨æ¯”è¼ƒã—ã¦ã‚‹ã‚“ã ã‚ˆã­ã€‚"];
                const r = replies[Math.floor(Math.random()*replies.length)];
                area.innerHTML += `<div class="chat-bubble bubble-ai">${r}</div>`;
                area.scrollTop = area.scrollHeight;
            }, 1000);
        }

        function initiateCoinPurchase(coins, price) {
            pendingPayment = { coins, price };
            document.getElementById('wallet-modal').style.display='none';
            document.getElementById('pay-amount').innerText = price;
            document.getElementById('payment-gateway-modal').style.display='flex';
        }

        function processPaymentMock(method) {
            if(!pendingPayment) return;
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            dummyUsers[myName].coins += pendingPayment.coins;
            saveData();
            alert(`æ±ºæ¸ˆå®Œäº†: ${method}\n${pendingPayment.coins}ã‚³ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
            document.getElementById('payment-gateway-modal').style.display='none';
            refreshApp();
        }

        function subscribeSystem(plan, price) {
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            if(dummyUsers[myName].coins < price) return alert("ã‚³ã‚¤ãƒ³ä¸è¶³ã§ã™");
            if(confirm("ãƒ—ãƒ©ãƒ³å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ")) {
                dummyUsers[myName].coins -= price;
                dummyUsers[myName].plan = plan;
                if(plan !== 'standard') dummyUsers[myName].isPro = true;
                saveData();
                alert("å¤‰æ›´ã—ã¾ã—ãŸ");
                document.getElementById('system-plan-modal').style.display='none';
                refreshApp();
            }
        }

        function saveCreatorSettings() {
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            dummyUsers[myName].mySubPrice = document.getElementById('creator-price').value;
            dummyUsers[myName].mySubActive = document.getElementById('creator-status').value === 'on';
            saveData();
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            document.getElementById('creator-modal').style.display='none';
        }

        function saveProfile() {
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            const u = dummyUsers[myName];
            const newName = document.getElementById('edit-name').value;
            if(newName) u.name = newName;
            u.history = document.getElementById('edit-history').value;
            u.role = document.getElementById('edit-role').value;
            u.bio = document.getElementById('edit-bio').value;
            u.social.twitter = document.getElementById('edit-twitter').value;
            u.social.insta = document.getElementById('edit-insta').value;
            u.social.threads = document.getElementById('edit-threads').value;
            if(document.getElementById('edit-avatar-img').src) u.img = document.getElementById('edit-avatar-img').src;
            saveData();
            sessionStorage.setItem('closer_logged_in_user', JSON.stringify(u));
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            backToPrev();
            refreshApp();
        }
        
        function openReplyInput(ansId) {
            const inputArea = document.getElementById('reply-input-' + ansId);
            if(inputArea.style.display === 'none') {
                inputArea.style.display = 'flex';
            } else {
                inputArea.style.display = 'none';
            }
        }

        /* --- ä¿®æ­£ç‰ˆ: è¿”ä¿¡é€ä¿¡ï¼ˆã‚²ã‚¹ãƒˆå¯¾å¿œï¼‰ --- */
        function submitReply(ansId) {
            if(isGuest) { alert("è¿”ä¿¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return navTo('auth-screen'); }
            
            const txtInput = document.getElementById('reply-text-' + ansId);
            const txt = txtInput.value;
            if(!txt) return;
            const ans = dummyAnswers.find(a => a.id === ansId);
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            if(!ans.replies) ans.replies = [];
            ans.replies.push({user: myName, text: txt});
            saveData();
            refreshApp();
            alert("è¿”ä¿¡ã—ã¾ã—ãŸ");
        }

        /* --- å›ç­”è©³ç´°ãƒ»è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¸Šæ›¸ãå®šç¾©ï¼‰ --- */
        let currentViewingAnswerId = null;

        function showRatingInput() {
            document.getElementById('rating-input-area').style.display = 'block';
            document.getElementById('rating-result-area').style.display = 'none';
            document.getElementById('new-rate-logic').value = 3;
            document.getElementById('new-rate-tone').value = 3;
            document.getElementById('new-rate-empathy').value = 3;
            updateRateVal('logic', 3);
            updateRateVal('tone', 3);
            updateRateVal('empathy', 3);
        }

        function showRatingResult(ans) {
            document.getElementById('rating-input-area').style.display = 'none';
            document.getElementById('rating-result-area').style.display = 'block';
            let totalScore = 0;
            let count = 0;
            if(ans.votes) {
                for (let score in ans.votes) {
                    let num = ans.votes[score];
                    totalScore += parseInt(score) * num;
                    count += num;
                }
            }
            const avg = count > 0 ? (totalScore / count).toFixed(2) : "0.00";
            document.getElementById('result-score-display').innerText = avg;
            document.getElementById('result-count-display').innerText = `Based on ${count} votes`;
        }

        function submitNewRating() {
            if(isGuest) { alert("è©•ä¾¡ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™"); return navTo('auth-screen'); }
            const logic = parseInt(document.getElementById('new-rate-logic').value);
            const tone = parseInt(document.getElementById('new-rate-tone').value);
            const empathy = parseInt(document.getElementById('new-rate-empathy').value);
            const avg = Math.round((logic + tone + empathy) / 3);
            const ans = dummyAnswers.find(a => a.id === currentViewingAnswerId);
            if(!ans.votes) ans.votes = {};
            if(!ans.votes[avg]) ans.votes[avg] = 0;
            ans.votes[avg]++;
            const myName = JSON.parse(sessionStorage.getItem('closer_logged_in_user')).name;
            if(!dummyUsers[myName].votedAnswers) dummyUsers[myName].votedAnswers = [];
            dummyUsers[myName].votedAnswers.push(currentViewingAnswerId);
            saveData();
            showRatingResult(ans);
            alert("è©•ä¾¡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚");
        }  
        /* --- ä¼æ¥­ã¨ã®ãƒãƒ£ãƒƒãƒˆé–‹å§‹ç”¨ --- */
        function startChatWithCompany(companyName) {
            // ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ä¼æ¥­ã‚’ç™»éŒ²ï¼ˆãƒãƒ£ãƒƒãƒˆç”»é¢è¡¨ç¤ºã®ãŸã‚ï¼‰
            if(!dummyUsers[companyName]) {
                dummyUsers[companyName] = { 
                    name: companyName, 
                    role: 'Recruiter', 
                    rate: '---', 
                    img: '', 
                    bio: 'æ¡ç”¨æ‹…å½“ã§ã™ã€‚', 
                    isAnonymous: false,
                    mySubActive: false, // ä¼æ¥­ã¯ã‚µãƒ–ã‚¹ã‚¯ä¸è¦
                    subscriptions: []
                };
            }
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ã¸åˆ‡ã‚Šæ›¿ãˆ
            openProfile(companyName);
            switchProfileTab('chat');
        }
    </script>
</body>
</html>















